<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Neon Overdrive: Cyber-Parallax</title>
    <style>
        body { margin: 0; background: #050508; display: flex; flex-direction: column; justify-content: center; align-items: center; height: 100vh; color: white; font-family: 'Segoe UI', sans-serif; overflow: hidden; }
        canvas { background: #0a0a0f; border: 2px solid #1a1a25; border-radius: 12px; box-shadow: 0 0 50px rgba(0,210,255,0.15); }
        .hud-container { width: 800px; display: flex; justify-content: space-between; margin-bottom: 10px; align-items: center; }
        .hud { font-size: 24px; font-weight: bold; letter-spacing: 2px; color: #00d2ff; text-shadow: 0 0 10px rgba(0,210,255,0.5); }
        
        /* Shop Overlay */
        #shopUI {
            position: absolute; background: rgba(5, 5, 8, 0.95); border: 2px solid #00d2ff;
            padding: 20px; border-radius: 10px; display: none; flex-direction: column; gap: 10px;
            box-shadow: 0 0 30px rgba(0, 210, 255, 0.3); z-index: 10; width: 280px;
        }
        .shop-item { padding: 10px; border: 1px solid #1a1a25; cursor: pointer; display: flex; justify-content: space-between; transition: 0.2s; font-size: 14px; }
        .shop-item:hover { background: rgba(0, 210, 255, 0.1); }
        .unlocked { border-color: #00ff88; color: #00ff88; }
        .equipped { border-color: #00ff88; background: rgba(0, 255, 136, 0.1); color: #00ff88; }
        .section-label { font-size: 10px; color: #555; margin-top: 10px; text-transform: uppercase; letter-spacing: 1px; }
        /* Username Entry Screen */
        #usernameOverlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(5, 5, 8, 0.97); display: flex; flex-direction: column;
            justify-content: center; align-items: center; z-index: 100;
        }
        #usernameOverlay h1 {
            font-size: 36px; color: #00d2ff; text-shadow: 0 0 20px rgba(0,210,255,0.6);
            margin-bottom: 8px; letter-spacing: 4px;
        }
        #usernameOverlay p {
            color: #555; font-size: 14px; margin-bottom: 30px;
        }
        #usernameInput {
            background: rgba(10, 10, 15, 0.9); border: 2px solid #00d2ff; color: #00d2ff;
            font-size: 20px; padding: 12px 20px; border-radius: 8px; text-align: center;
            outline: none; font-family: 'Segoe UI', sans-serif; letter-spacing: 2px;
            width: 280px; box-shadow: 0 0 15px rgba(0,210,255,0.2);
        }
        #usernameInput::placeholder { color: #334; }
        #usernameInput:focus { box-shadow: 0 0 25px rgba(0,210,255,0.4); }
        #usernameSubmit {
            margin-top: 18px; background: transparent; border: 2px solid #00ff88; color: #00ff88;
            font-size: 16px; padding: 10px 40px; border-radius: 8px; cursor: pointer;
            font-family: 'Segoe UI', sans-serif; letter-spacing: 2px;
            transition: 0.2s; text-transform: uppercase;
        }
        #usernameSubmit:hover { background: rgba(0,255,136,0.1); box-shadow: 0 0 15px rgba(0,255,136,0.3); }
        /* Level Selector (mod menu) */
        #levelSelector {
            position: absolute; background: rgba(5, 5, 8, 0.95); border: 2px solid #ffcc00;
            padding: 15px; border-radius: 10px; display: none; flex-direction: column; gap: 6px;
            box-shadow: 0 0 30px rgba(255, 204, 0, 0.3); z-index: 10; width: 220px;
            max-height: 350px; overflow-y: auto;
        }
        #levelSelector h3 { margin: 0 0 8px 0; color: #ffcc00; text-align: center; font-size: 14px; }
        .level-btn {
            padding: 6px 10px; border: 1px solid #332200; background: transparent;
            color: #ffcc00; cursor: pointer; font-size: 12px; font-family: 'Segoe UI', sans-serif;
            text-align: left; transition: 0.2s; border-radius: 4px;
        }
        .level-btn:hover { background: rgba(255, 204, 0, 0.1); border-color: #ffcc00; }
        /* Settings Menu */
        #settingsUI {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(5, 5, 8, 0.92); display: none; flex-direction: column;
            justify-content: center; align-items: center; z-index: 50;
        }
        #settingsPanel {
            background: rgba(10, 10, 20, 0.98); border: 2px solid #00d2ff;
            padding: 25px 30px; border-radius: 12px; width: 320px;
            box-shadow: 0 0 40px rgba(0, 210, 255, 0.3);
        }
        #settingsPanel h2 {
            margin: 0 0 20px 0; color: #00d2ff; text-align: center; font-size: 20px;
            letter-spacing: 3px; text-shadow: 0 0 15px rgba(0,210,255,0.5);
        }
        .settings-row {
            display: flex; justify-content: space-between; align-items: center;
            padding: 10px 0; border-bottom: 1px solid #1a1a25;
        }
        .settings-row:last-of-type { border-bottom: none; }
        .settings-label { color: #aaa; font-size: 13px; letter-spacing: 1px; }
        .settings-value { color: #00d2ff; font-size: 12px; min-width: 30px; text-align: right; }
        .settings-slider {
            -webkit-appearance: none; appearance: none; width: 120px; height: 6px;
            background: #1a1a25; border-radius: 3px; outline: none;
        }
        .settings-slider::-webkit-slider-thumb {
            -webkit-appearance: none; appearance: none; width: 16px; height: 16px;
            background: #00d2ff; border-radius: 50%; cursor: pointer;
            box-shadow: 0 0 8px rgba(0,210,255,0.5);
        }
        .settings-toggle {
            width: 40px; height: 22px; background: #1a1a25; border-radius: 11px;
            position: relative; cursor: pointer; border: 1px solid #333;
            transition: 0.2s;
        }
        .settings-toggle.active { background: rgba(0, 210, 255, 0.3); border-color: #00d2ff; }
        .settings-toggle::after {
            content: ''; position: absolute; top: 2px; left: 2px;
            width: 16px; height: 16px; background: #555; border-radius: 50%;
            transition: 0.2s;
        }
        .settings-toggle.active::after { left: 20px; background: #00d2ff; }
        .settings-checkbox {
            width: 18px; height: 18px; background: #1a1a25; border: 1px solid #333;
            border-radius: 4px; cursor: pointer; display: flex; align-items: center;
            justify-content: center; transition: 0.2s; font-size: 12px; color: #00d2ff;
        }
        .settings-checkbox.checked { border-color: #00d2ff; background: rgba(0,210,255,0.15); }
        #settingsResetBtn {
            margin-top: 18px; width: 100%; background: transparent; border: 2px solid #ff3333;
            color: #ff3333; font-size: 13px; padding: 8px; border-radius: 6px; cursor: pointer;
            font-family: 'Segoe UI', sans-serif; letter-spacing: 2px; transition: 0.2s;
            text-transform: uppercase;
        }
        #settingsResetBtn:hover { background: rgba(255, 51, 51, 0.15); box-shadow: 0 0 15px rgba(255,51,51,0.3); }
        #settingsCloseBtn {
            margin-top: 10px; width: 100%; background: transparent; border: 2px solid #00d2ff;
            color: #00d2ff; font-size: 13px; padding: 8px; border-radius: 6px; cursor: pointer;
            font-family: 'Segoe UI', sans-serif; letter-spacing: 2px; transition: 0.2s;
            text-transform: uppercase;
        }
        #settingsCloseBtn:hover { background: rgba(0,210,255,0.1); box-shadow: 0 0 15px rgba(0,210,255,0.3); }
        /* Mobile Controls */
        #mobileControls {
            display: none;
            width: 100%;
            max-width: 800px;
            padding: 8px 10px;
            box-sizing: border-box;
            justify-content: space-between;
            align-items: center;
            gap: 10px;
            touch-action: none;
            -webkit-user-select: none;
            user-select: none;
        }
        .mobile-btn {
            width: 64px;
            height: 64px;
            border: 2px solid #00d2ff;
            border-radius: 14px;
            background: rgba(0, 210, 255, 0.08);
            color: #00d2ff;
            font-size: 26px;
            font-weight: bold;
            display: flex;
            align-items: center;
            justify-content: center;
            touch-action: none;
            -webkit-user-select: none;
            user-select: none;
            box-shadow: 0 0 12px rgba(0, 210, 255, 0.2);
            transition: background 0.1s, box-shadow 0.1s;
        }
        .mobile-btn.active {
            background: rgba(0, 210, 255, 0.25);
            box-shadow: 0 0 20px rgba(0, 210, 255, 0.5);
        }
        .mobile-btn-jump {
            width: 90px;
            height: 90px;
            border-radius: 50%;
            font-size: 20px;
            letter-spacing: 1px;
        }
        .mobile-btn-shop {
            width: 50px;
            height: 50px;
            font-size: 14px;
            border-color: #ffcc00;
            color: #ffcc00;
            background: rgba(255, 204, 0, 0.08);
            box-shadow: 0 0 12px rgba(255, 204, 0, 0.2);
        }
        .mobile-btn-shop.active {
            background: rgba(255, 204, 0, 0.25);
            box-shadow: 0 0 20px rgba(255, 204, 0, 0.5);
        }
        .mobile-left-group, .mobile-right-group {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .mobile-right-group {
            gap: 14px;
        }
        /* Responsive scaling for mobile */
        @media (max-width: 820px) {
            .hud-container { width: 95vw; }
            .hud { font-size: 16px; }
            canvas { width: 95vw; height: auto; }
            #mobileControls { display: flex; }
        }
        @media (max-width: 500px) {
            .hud { font-size: 13px; letter-spacing: 1px; }
            .mobile-btn { width: 54px; height: 54px; font-size: 22px; border-radius: 12px; }
            .mobile-btn-jump { width: 74px; height: 74px; font-size: 16px; }
            .mobile-btn-shop { width: 42px; height: 42px; font-size: 11px; }
        }
    </style>
</head>
<body>
    <!-- Username Entry Screen -->
    <div id="usernameOverlay">
        <h1>NEON OVERDRIVE</h1>
        <p>Enter your callsign, operative</p>
        <input type="text" id="usernameInput" placeholder="USERNAME" maxlength="20" autocomplete="off">
        <button id="usernameSubmit">JACK IN</button>
    </div>
    <div class="hud-container">
        <div class="hud" id="levelDisplay">LEVEL 01</div>
        <div style="font-size: 12px; color: #444;">[S] SHOP</div>
        <div class="hud" id="scoreDisplay">SCORE: 0000</div>
        <div style="display: flex; gap: 15px; align-items: center;">
            <div style="font-size: 12px; color: #444;">[S] SHOP</div>
            <div id="modHint" style="font-size: 12px; color: #664400; display: none;">[L] LEVELS | FLY: HOLD JUMP</div>
        </div>
        <div style="display: flex; flex-direction: column; align-items: flex-end;">
            <div class="hud" id="scoreDisplay">SCORE: 0000</div>
            <div id="usernameDisplay" style="font-size: 11px; color: #00d2ff; letter-spacing: 1px; opacity: 0.7;"></div>
        </div>
    </div>
    <!-- Level Selector (mod menu) -->
    <div id="levelSelector"></div>
    <!-- Settings Menu -->
    <div id="settingsUI">
        <div id="settingsPanel">
            <h2>SYSTEM SETTINGS</h2>
            <div class="settings-row">
                <span class="settings-label">Particle Intensity</span>
                <div style="display:flex;align-items:center;gap:8px;">
                    <input type="range" id="particleSlider" class="settings-slider" min="0" max="200" value="100">
                    <span class="settings-value" id="particleValue">100%</span>
                </div>
            </div>
            <div class="settings-row">
                <span class="settings-label">Screen Shake</span>
                <div class="settings-toggle active" id="shakeToggle"></div>
            </div>
            <div class="settings-row">
                <span class="settings-label">Speedrun Timer</span>
                <div class="settings-checkbox checked" id="timerCheckbox">&#10003;</div>
            </div>
            <div class="settings-row">
                <span class="settings-label">Music Volume</span>
                <div style="display:flex;align-items:center;gap:8px;">
                    <input type="range" id="musicSlider" class="settings-slider" min="0" max="100" value="50">
                    <span class="settings-value" id="musicValue">50%</span>
                </div>
            </div>
            <div class="settings-row">
                <span class="settings-label">SFX Volume</span>
                <div style="display:flex;align-items:center;gap:8px;">
                    <input type="range" id="sfxSlider" class="settings-slider" min="0" max="100" value="70">
                    <span class="settings-value" id="sfxValue">70%</span>
                </div>
            </div>
            <button id="settingsResetBtn">Reset Progress</button>
            <button id="settingsCloseBtn">Close</button>
        </div>
    </div>
    <div id="shopUI">
        <h3 style="margin: 0 0 10px 0; color: #00d2ff; text-align: center;">NEON SHOP</h3>
        
        <div class="section-label">Core Colors</div>
        <div class="shop-item unlocked equipped" id="shop-cyan" onclick="buyColor('#00d2ff', 0, 'shop-cyan')"><span>CYAN</span> <span class="status">FREE</span></div>
        <div class="shop-item" id="shop-lime" onclick="buyColor('#00ff88', 300, 'shop-lime')"><span>LIME</span> <span class="status">300 PTS</span></div>
        <div class="shop-item" id="shop-void" onclick="buyColor('#bc13fe', 700, 'shop-void')"><span>VOID</span> <span class="status">700 PTS</span></div>
        <div class="shop-item" id="shop-gold" onclick="buyColor('#ffcc00', 1300, 'shop-gold')"><span>GOLD</span> <span class="status">1300 PTS</span></div>
        <div class="section-label">Unit Chassis</div>
        <div class="shop-item unlocked equipped" id="unit-cube" onclick="buyUnit('cube', 0, 'unit-cube')"><span>CUBE-X</span> <span class="status">FREE</span></div>
        <div class="shop-item" id="unit-tri" onclick="buyUnit('tri', 1000, 'unit-tri')"><span>INTERCEPTOR</span> <span class="status">1000 PTS</span></div>
        <div class="shop-item" id="unit-circle" onclick="buyUnit('circle', 2000, 'unit-circle')"><span>ORBITER</span> <span class="status">2000 PTS</span></div>
        <button onclick="toggleShop()" style="margin-top: 10px; background: #ff3333; border: none; color: white; padding: 5px; cursor: pointer;">CLOSE</button>
    </div>
    <canvas id="gameCanvas"></canvas>
    <!-- Mobile Touch Controls -->
    <div id="mobileControls">
        <div class="mobile-left-group">
            <div class="mobile-btn" id="btnLeft">&#9664;</div>
            <div class="mobile-btn" id="btnRight">&#9654;</div>
        </div>
        <div class="mobile-right-group">
            <div class="mobile-btn mobile-btn-shop" id="btnShop">SHOP</div>
            <div class="mobile-btn mobile-btn-jump" id="btnJump">JUMP</div>
        </div>
    </div>
    <script>
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        canvas.width = 800;
        canvas.height = 400;
        let currentLevel = 0;
        let score = 0;
        let playerUsername = '';
        let isMod = false;
        let levelSelectorOpen = false;
        let gameStarted = false;
        const gravity = 0.45;
        const friction = 0.85;
        const keys = {};
        let hangTime = 0;
        let particles = [];
        let deathTimer = 0;
        let shopOpen = false;
        let settingsOpen = false;
        let trails = [];
        // Settings state
        let particleIntensity = 1.0;
        let screenShakeEnabled = true;
        let showSpeedrunTimer = true;
        let screenShakeX = 0;
        let screenShakeY = 0;
        let musicVolume = 0.5;
        let sfxVolume = 0.7;
        // === AUDIO ENGINE (Web Audio API) ===
        let audioCtx = null;
        let masterGain = null;
        let musicGain = null;
        let sfxGain = null;
        let currentMusicNodes = [];
        let currentMusicType = null; // 'normal' or 'boss'
        let musicInterval = null;
        function initAudio() {
            if (audioCtx) return;
            audioCtx = new (window.AudioContext || window.webkitAudioContext)();
            masterGain = audioCtx.createGain();
            masterGain.connect(audioCtx.destination);
            musicGain = audioCtx.createGain();
            musicGain.gain.value = musicVolume;
            musicGain.connect(masterGain);
            sfxGain = audioCtx.createGain();
            sfxGain.gain.value = sfxVolume;
            sfxGain.connect(masterGain);
        }
        function playNote(freq, duration, type, gainVal, dest, delay) {
            if (!audioCtx) return;
            let t = audioCtx.currentTime + (delay || 0);
            let osc = audioCtx.createOscillator();
            let g = audioCtx.createGain();
            osc.type = type || 'sine';
            osc.frequency.setValueAtTime(freq, t);
            g.gain.setValueAtTime(gainVal || 0.15, t);
            g.gain.exponentialRampToValueAtTime(0.001, t + duration);
            osc.connect(g);
            g.connect(dest || sfxGain);
            osc.start(t);
            osc.stop(t + duration);
        }
        function playNoise(duration, gainVal, dest, delay) {
            if (!audioCtx) return;
            let t = audioCtx.currentTime + (delay || 0);
            let bufSize = audioCtx.sampleRate * duration;
            let buf = audioCtx.createBuffer(1, bufSize, audioCtx.sampleRate);
            let data = buf.getChannelData(0);
            for (let i = 0; i < bufSize; i++) data[i] = Math.random() * 2 - 1;
            let src = audioCtx.createBufferSource();
            src.buffer = buf;
            let g = audioCtx.createGain();
            g.gain.setValueAtTime(gainVal || 0.1, t);
            g.gain.exponentialRampToValueAtTime(0.001, t + duration);
            src.connect(g);
            g.connect(dest || sfxGain);
            src.start(t);
        }
        // --- Sound Effects ---
        function playSfxBuy() {
            playNote(880, 0.1, 'sine', 0.12, sfxGain, 0);
            playNote(1100, 0.1, 'sine', 0.1, sfxGain, 0.07);
            playNote(1320, 0.15, 'sine', 0.12, sfxGain, 0.14);
            playNote(1760, 0.2, 'triangle', 0.08, sfxGain, 0.2);
        }
        function playSfxDeath() {
            playNoise(0.3, 0.2, sfxGain, 0);
            playNote(200, 0.3, 'sawtooth', 0.15, sfxGain, 0);
            playNote(100, 0.4, 'square', 0.1, sfxGain, 0.1);
            playNote(50, 0.5, 'sawtooth', 0.08, sfxGain, 0.2);
        }
        function playSfxJump() {
            if (!audioCtx) return;
            let osc = audioCtx.createOscillator();
            let g = audioCtx.createGain();
            osc.type = 'sine';
            osc.frequency.setValueAtTime(300, audioCtx.currentTime);
            osc.frequency.exponentialRampToValueAtTime(600, audioCtx.currentTime + 0.1);
            g.gain.setValueAtTime(0.08, audioCtx.currentTime);
            g.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime + 0.12);
            osc.connect(g);
            g.connect(sfxGain);
            osc.start();
            osc.stop(audioCtx.currentTime + 0.12);
        }
        function playSfxBossHit() {
            playNoise(0.15, 0.15, sfxGain, 0);
            playNote(150, 0.2, 'square', 0.12, sfxGain, 0);
            playNote(250, 0.15, 'sawtooth', 0.1, sfxGain, 0.05);
        }
        function playSfxLevelComplete() {
            playNote(523, 0.12, 'sine', 0.1, sfxGain, 0);
            playNote(659, 0.12, 'sine', 0.1, sfxGain, 0.1);
            playNote(784, 0.12, 'sine', 0.1, sfxGain, 0.2);
            playNote(1047, 0.3, 'triangle', 0.12, sfxGain, 0.3);
        }
        // --- Music Engine ---
        function stopMusic() {
            if (musicInterval) { clearInterval(musicInterval); musicInterval = null; }
            currentMusicNodes.forEach(n => { try { n.stop(); } catch(e){} });
            currentMusicNodes = [];
            currentMusicType = null;
        }
        function startNormalMusic() {
            if (currentMusicType === 'normal') return;
            stopMusic();
            currentMusicType = 'normal';
            let bpm = 110;
            let beatLen = 60 / bpm;
            // Chill synthwave arpeggio pattern
            let notes = [
                [261.6, 329.6, 392.0, 329.6], // C E G E
                [220.0, 277.2, 329.6, 277.2], // A C# E C#
                [246.9, 311.1, 370.0, 311.1], // B D# F# D#
                [196.0, 246.9, 293.7, 246.9]  // G B D B
            ];
            let bar = 0;
            let step = 0;
            function playStep() {
                if (!audioCtx || currentMusicType !== 'normal') return;
                let pattern = notes[bar % notes.length];
                let freq = pattern[step % pattern.length];
                // Arpeggio note
                playNote(freq, beatLen * 0.8, 'triangle', 0.06, musicGain, 0);
                // Subtle bass on beat 0
                if (step === 0) {
                    playNote(freq / 2, beatLen * 3.5, 'sine', 0.05, musicGain, 0);
                }
                // Soft pad chord on beat 0
                if (step === 0) {
                    playNote(freq, beatLen * 3.8, 'sine', 0.025, musicGain, 0);
                    playNote(freq * 1.26, beatLen * 3.8, 'sine', 0.02, musicGain, 0);
                    playNote(freq * 1.5, beatLen * 3.8, 'sine', 0.015, musicGain, 0);
                }
                step++;
                if (step >= 4) { step = 0; bar++; }
            }
            playStep();
            musicInterval = setInterval(playStep, beatLen * 1000);
        }
        function startBossMusic() {
            if (currentMusicType === 'boss') return;
            stopMusic();
            currentMusicType = 'boss';
            let bpm = 160;
            let beatLen = 60 / bpm;
            // Aggressive bass pattern
            let bassNotes = [
                [82.4, 82.4, 98.0, 82.4, 110.0, 82.4, 73.4, 82.4],  // E2 based
                [73.4, 73.4, 87.3, 73.4, 98.0, 73.4, 65.4, 73.4],   // D2 based
            ];
            let bar = 0;
            let step = 0;
            function playStep() {
                if (!audioCtx || currentMusicType !== 'boss') return;
                let pattern = bassNotes[bar % bassNotes.length];
                let freq = pattern[step % pattern.length];
                // Heavy bass
                playNote(freq, beatLen * 0.6, 'sawtooth', 0.08, musicGain, 0);
                // Distorted lead on certain beats
                if (step % 2 === 0) {
                    playNote(freq * 4, beatLen * 0.3, 'square', 0.04, musicGain, 0);
                }
                // Kick-like thump on beats 0 and 4
                if (step === 0 || step === 4) {
                    playNote(55, 0.15, 'sine', 0.12, musicGain, 0);
                    playNoise(0.05, 0.06, musicGain, 0);
                }
                // Snare-like noise on beats 2 and 6
                if (step === 2 || step === 6) {
                    playNoise(0.08, 0.08, musicGain, 0);
                    playNote(200, 0.08, 'triangle', 0.06, musicGain, 0);
                }
                // Hi-hat noise every beat
                playNoise(0.03, 0.03, musicGain, 0);
                step++;
                if (step >= 8) { step = 0; bar++; }
            }
            playStep();
            musicInterval = setInterval(playStep, beatLen * 1000);
        }
        function updateMusicForLevel() {
            if (!audioCtx) return;
            let lvl = levels[currentLevel];
            if (lvl && lvl.isBoss) {
                startBossMusic();
            } else {
                startNormalMusic();
            }
        }
        // Speedrun stopwatch
        let stopwatchStarted = false;
        let stopwatchStartTime = 0;
        let stopwatchElapsed = 0;
        let stopwatchFinal = 0;
        let gameFinished = false;
        // Boss state
        let boss = null;
        let bossProjectiles = [];
        let bossFireTimer = 0;
        let bossDefeated = false;
        let bossDeathTimer = 0;
        let bossFlashTimer = 0;
        let bossPulse = 0;
        let bossType = 'terminator'; // 'terminator' or 'queen'
        let queenBurstCount = 0;
        let queenBurstTimer = 0;
        let queenGlitchTimer = 0;
        const hexes = [];
        for(let i=0; i<15; i++) {
            hexes.push({
                x: Math.random() * 2000,
                y: Math.random() * 400,
                size: Math.random() * 40 + 20,
                speed: Math.random() * 0.5 + 0.2
            });
        }
        const player = {
            x: 50, y: 300, oldY: 300,
            width: 22, height: 22,
            velX: 0, velY: 0,
            speed: 7, jumpPower: -12,
            grounded: false, rotation: 0,
            wasGrounded: false, visible: true,
            color: '#00d2ff',
            shape: 'cube',
            unlocked: ['#00d2ff'],
            unlockedUnits: ['cube']
        };
        const camera = { x: 0, y: 0 };
        function formatTime(ms) {
            let totalCentis = Math.floor(ms / 10);
            let centis = totalCentis % 100;
            let totalSec = Math.floor(totalCentis / 100);
            let sec = totalSec % 60;
            let min = Math.floor(totalSec / 60);
            let secStr = min > 0 ? sec.toString().padStart(2, '0') : sec.toString();
            return (min > 0 ? (min + ':') : '') + secStr + '.' + centis.toString().padStart(2, '0');
        }
        function drawStopwatch() {
            if (!showSpeedrunTimer) return;
            let ms = 0;
            if (gameFinished) ms = stopwatchFinal;
            else if (stopwatchStarted) ms = performance.now() - stopwatchStartTime;
            ctx.save();
            ctx.font = 'bold 14px Segoe UI';
            ctx.textAlign = 'right';
            ctx.fillStyle = gameFinished ? '#00ff88' : '#ffffff';
            ctx.shadowBlur = 8;
            ctx.shadowColor = gameFinished ? '#00ff88' : '#00d2ff';
            ctx.fillText('TIME ' + formatTime(ms), canvas.width - 15, canvas.height - 15);
            ctx.shadowBlur = 0;
            ctx.restore();
        }
        function triggerScreenShake(intensity) {
            if (!screenShakeEnabled) return;
            screenShakeX = (Math.random() - 0.5) * intensity;
            screenShakeY = (Math.random() - 0.5) * intensity;
        }
        function toggleShop() {
            if (settingsOpen) { toggleSettings(); }
            shopOpen = !shopOpen;
            document.getElementById('shopUI').style.display = shopOpen ? 'flex' : 'none';
        }
        function toggleSettings() {
            if (shopOpen) { shopOpen = false; document.getElementById('shopUI').style.display = 'none'; }
            settingsOpen = !settingsOpen;
            document.getElementById('settingsUI').style.display = settingsOpen ? 'flex' : 'none';
        }
        function buyColor(color, cost, id) {
            if (player.unlocked.includes(color)) {
                player.color = color;
                updateShopUI();
                playSfxBuy();
            } else if (score >= cost) {
                score -= cost;
                player.unlocked.push(color);
                player.color = color;
                updateShopUI();
                playSfxBuy();
                document.getElementById('scoreDisplay').innerText = `SCORE: ${score.toString().padStart(4, '0')}`;
            }
        }
        function buyUnit(shape, cost, id) {
            if (player.unlockedUnits.includes(shape)) {
                player.shape = shape;
                updateShopUI();
                playSfxBuy();
            } else if (score >= cost) {
                score -= cost;
                player.unlockedUnits.push(shape);
                player.shape = shape;
                updateShopUI();
                playSfxBuy();
                document.getElementById('scoreDisplay').innerText = `SCORE: ${score.toString().padStart(4, '0')}`;
            }
        }
        function updateShopUI() {
            const colorItems = [
                {id: 'shop-cyan', code: '#00d2ff'},
                {id: 'shop-lime', code: '#00ff88'},
                {id: 'shop-void', code: '#bc13fe'},
                {id: 'shop-gold', code: '#ffcc00'}
            ];
            colorItems.forEach(itemData => {
                const item = document.getElementById(itemData.id);
                if(!item) return;
                const status = item.querySelector('.status');
                item.classList.remove('equipped', 'unlocked');
                if (player.color === itemData.code) {
                    item.classList.add('unlocked', 'equipped');
                    status.innerText = "EQUIPPED";
                } else if (player.unlocked.includes(itemData.code)) {
                    item.classList.add('unlocked');
                    status.innerText = "OWNED";
                }
            });
            const unitItems = [
                {id: 'unit-cube', type: 'cube'},
                {id: 'unit-tri', type: 'tri'},
                {id: 'unit-circle', type: 'circle'}
            ];
            unitItems.forEach(itemData => {
                const item = document.getElementById(itemData.id);
                const status = item.querySelector('.status');
                item.classList.remove('equipped', 'unlocked');
                if (player.shape === itemData.type) {
                    item.classList.add('unlocked', 'equipped');
                    status.innerText = "EQUIPPED";
                } else if (player.unlockedUnits.includes(itemData.type)) {
                    item.classList.add('unlocked');
                    status.innerText = "OWNED";
                }
            });
        }
        class Particle {
            constructor(x, y, color) {
                this.x = x; this.y = y;
                this.size = Math.random() * 3 + 1;
                this.speedX = (Math.random() - 0.5) * 10;
                this.speedY = (Math.random() - 0.5) * 10;
                this.color = color;
                this.alpha = 1;
                this.decay = Math.random() * 0.02 + 0.015;
            }
            update() {
                this.x += this.speedX; this.y += this.speedY;
                this.alpha -= this.decay;
            }
            draw() {
                ctx.save();
                ctx.globalAlpha = Math.max(0, this.alpha);
                ctx.fillStyle = this.color;
                ctx.fillRect(this.x, this.y, this.size, this.size);
                ctx.restore();
            }
        }
        function createExplosion(x, y, color, count) {
            for (let i = 0; i < count; i++) particles.push(new Particle(x, y, color));
            let adjustedCount = Math.round(count * particleIntensity);
            for (let i = 0; i < adjustedCount; i++) particles.push(new Particle(x, y, color));
        }
        const levels = [
            // LEVEL 1: Intro - flat ground, one enemy, reach the goal
            { width: 1600, startX: 50, startY: 300, objects: [
                { x: 0, y: 380, w: 1600, h: 20, type: 'platform' },
                { x: 600, y: 340, w: 40, h: 40, type: 'enemy', range: 200, speed: 3, currentX: 600, startX: 600, dir: 1, isDead: false },
                { x: 1550, y: 300, w: 40, h: 40, type: 'goal' }
            ]},
            // LEVEL 2: Lava gap platforming
            { width: 2000, startX: 50, startY: 300, objects: [
                { x: 0, y: 380, w: 400, h: 20, type: 'platform' },
                { x: 400, y: 385, w: 1200, h: 15, type: 'lava' },
                { x: 550, y: 280, w: 200, h: 20, type: 'platform' },
                { x: 900, y: 220, w: 200, h: 20, type: 'platform' },
                { x: 1250, y: 280, w: 200, h: 20, type: 'platform' },
                { x: 1600, y: 380, w: 400, h: 20, type: 'platform' },
                { x: 1950, y: 300, w: 40, h: 40, type: 'goal' }
            ]},
            // LEVEL 3: Enemy gauntlet on flat ground
            { width: 2200, startX: 50, startY: 300, objects: [
                { x: 0, y: 380, w: 2200, h: 20, type: 'platform' },
                { x: 500, y: 340, w: 40, h: 40, type: 'enemy', range: 100, speed: 6, currentX: 500, startX: 500, dir: 1, isDead: false },
                { x: 1000, y: 340, w: 40, h: 40, type: 'enemy', range: 100, speed: 8, currentX: 1000, startX: 1000, dir: -1, isDead: false },
                { x: 1500, y: 340, w: 40, h: 40, type: 'enemy', range: 100, speed: 10, currentX: 1500, startX: 1500, dir: 1, isDead: false },
                { x: 2150, y: 300, w: 40, h: 40, type: 'goal' }
            ]},
            // LEVEL 4: Vertical platforming over lava with an enemy
            { width: 2400, startX: 50, startY: 300, objects: [
                { x: 0, y: 380, w: 300, h: 20, type: 'platform' },
                { x: 300, y: 390, w: 1800, h: 10, type: 'lava' },
                { x: 400, y: 280, w: 100, h: 20, type: 'platform' },
                { x: 600, y: 200, w: 100, h: 20, type: 'platform' },
                { x: 850, y: 150, w: 100, h: 20, type: 'platform' },
                { x: 1100, y: 220, w: 100, h: 20, type: 'platform' },
                { x: 1250, y: 220, w: 300, h: 20, type: 'platform' },
                { x: 1350, y: 180, w: 40, h: 40, type: 'enemy', range: 100, speed: 5, currentX: 1350, startX: 1350, dir: 1, isDead: false },
                { x: 1650, y: 220, w: 150, h: 20, type: 'platform' },
                { x: 1900, y: 160, w: 100, h: 20, type: 'platform' },
                { x: 2100, y: 380, w: 300, h: 20, type: 'platform' },
                { x: 2350, y: 300, w: 40, h: 40, type: 'goal' }
            ]},
            // LEVEL 5: Mixed hazards - lava pits, fast enemies, platforming
            { width: 3000, startX: 50, startY: 300, objects: [
                { x: 0, y: 380, w: 3000, h: 20, type: 'platform' },
                { x: 400, y: 375, w: 150, h: 10, type: 'lava' },
                { x: 700, y: 340, w: 40, h: 40, type: 'enemy', range: 50, speed: 12, currentX: 700, startX: 700, dir: 1, isDead: false },
                { x: 850, y: 375, w: 200, h: 10, type: 'lava' },
                { x: 1100, y: 300, w: 100, h: 20, type: 'platform' },
                { x: 1300, y: 340, w: 40, h: 40, type: 'enemy', range: 150, speed: 4, currentX: 1300, startX: 1300, dir: 1, isDead: false },
                { x: 1350, y: 240, w: 150, h: 20, type: 'platform' },
                { x: 1650, y: 180, w: 100, h: 20, type: 'platform' },
                { x: 1950, y: 240, w: 150, h: 20, type: 'platform' },
                { x: 2150, y: 380, w: 400, h: 20, type: 'platform' },
                { x: 2100, y: 375, w: 500, h: 15, type: 'lava' },      
                { x: 2250, y: 280, w: 100, h: 20, type: 'platform' },
                { x: 2300, y: 340, w: 40, h: 40, type: 'enemy', range: 80, speed: 12, currentX: 2300, startX: 2300, dir: -1, isDead: false },
                { x: 2500, y: 320, w: 120, h: 20, type: 'platform' },
                { x: 2950, y: 250, w: 40, h: 40, type: 'goal' }
            ]},
            // LEVEL 6: "The Stairway"
            { width: 3200, startX: 50, startY: 300, objects: [
                { x: 0, y: 380, w: 250, h: 20, type: 'platform' },
                { x: 250, y: 390, w: 2700, h: 10, type: 'lava' },
                { x: 350, y: 320, w: 120, h: 20, type: 'platform' },
                { x: 550, y: 260, w: 120, h: 20, type: 'platform' },
                { x: 750, y: 200, w: 120, h: 20, type: 'platform' },
                { x: 950, y: 140, w: 150, h: 20, type: 'platform' },
                { x: 980, y: 100, w: 40, h: 40, type: 'enemy', range: 60, speed: 4, currentX: 980, startX: 980, dir: 1, isDead: false },
                { x: 1200, y: 200, w: 120, h: 20, type: 'platform' },
                { x: 1400, y: 260, w: 120, h: 20, type: 'platform' },
                { x: 1600, y: 320, w: 150, h: 20, type: 'platform' },
                { x: 1620, y: 280, w: 40, h: 40, type: 'enemy', range: 60, speed: 8, currentX: 1620, startX: 1620, dir: -1, isDead: false },
                { x: 1850, y: 260, w: 100, h: 20, type: 'platform' },
                { x: 2050, y: 190, w: 100, h: 20, type: 'platform' },
                { x: 2250, y: 130, w: 100, h: 20, type: 'platform' },
                { x: 2270, y: 90, w: 40, h: 40, type: 'enemy', range: 40, speed: 6, currentX: 2270, startX: 2270, dir: 1, isDead: false },
                { x: 2450, y: 200, w: 100, h: 20, type: 'platform' },
                { x: 2650, y: 280, w: 120, h: 20, type: 'platform' },
                { x: 2950, y: 380, w: 250, h: 20, type: 'platform' },
                { x: 3150, y: 300, w: 40, h: 40, type: 'goal' }
            ]},
            // LEVEL 7: "Lava Corridors"
            { width: 3500, startX: 50, startY: 300, objects: [
                { x: 0, y: 380, w: 300, h: 20, type: 'platform' },
                { x: 300, y: 380, w: 200, h: 20, type: 'lava' },
                { x: 500, y: 380, w: 150, h: 20, type: 'platform' },
                { x: 520, y: 340, w: 40, h: 40, type: 'enemy', range: 50, speed: 10, currentX: 520, startX: 520, dir: 1, isDead: false },
                { x: 650, y: 380, w: 250, h: 20, type: 'lava' },
                { x: 900, y: 380, w: 120, h: 20, type: 'platform' },
                { x: 1020, y: 380, w: 1200, h: 20, type: 'lava' },
                { x: 1050, y: 280, w: 100, h: 20, type: 'platform' },
                { x: 1250, y: 220, w: 130, h: 20, type: 'platform' },
                { x: 1270, y: 180, w: 40, h: 40, type: 'enemy', range: 50, speed: 7, currentX: 1270, startX: 1270, dir: -1, isDead: false },
                { x: 1480, y: 160, w: 130, h: 20, type: 'platform' },
                { x: 1710, y: 220, w: 130, h: 20, type: 'platform' },
                { x: 1940, y: 280, w: 100, h: 20, type: 'platform' },
                { x: 2220, y: 380, w: 600, h: 20, type: 'platform' },
                { x: 2300, y: 340, w: 40, h: 40, type: 'enemy', range: 80, speed: 9, currentX: 2300, startX: 2300, dir: 1, isDead: false },
                { x: 2550, y: 340, w: 40, h: 40, type: 'enemy', range: 80, speed: 11, currentX: 2550, startX: 2550, dir: -1, isDead: false },
                { x: 2820, y: 380, w: 300, h: 20, type: 'lava' },
                { x: 2880, y: 280, w: 80, h: 20, type: 'platform' },
                { x: 3050, y: 220, w: 80, h: 20, type: 'platform' },
                { x: 3200, y: 380, w: 300, h: 20, type: 'platform' },
                { x: 3450, y: 300, w: 40, h: 40, type: 'goal' }
            ]},
            // LEVEL 8: "The Gauntlet"
            { width: 4000, startX: 50, startY: 300, objects: [
                { x: 0, y: 380, w: 200, h: 20, type: 'platform' },
                { x: 200, y: 390, w: 3300, h: 10, type: 'lava' },
                { x: 300, y: 320, w: 80, h: 20, type: 'platform' },
                { x: 480, y: 260, w: 80, h: 20, type: 'platform' },
                { x: 500, y: 220, w: 40, h: 40, type: 'enemy', range: 30, speed: 6, currentX: 500, startX: 500, dir: 1, isDead: false },
                { x: 660, y: 200, w: 80, h: 20, type: 'platform' },
                { x: 840, y: 260, w: 80, h: 20, type: 'platform' },
                { x: 860, y: 220, w: 40, h: 40, type: 'enemy', range: 25, speed: 5, currentX: 860, startX: 860, dir: -1, isDead: false },
                { x: 1020, y: 180, w: 100, h: 20, type: 'platform' },
                { x: 1220, y: 220, w: 200, h: 20, type: 'platform' },
                { x: 1280, y: 180, w: 40, h: 40, type: 'enemy', range: 70, speed: 10, currentX: 1280, startX: 1280, dir: 1, isDead: false },
                { x: 1520, y: 280, w: 80, h: 20, type: 'platform' },
                { x: 1700, y: 340, w: 80, h: 20, type: 'platform' },
                { x: 1880, y: 380, w: 200, h: 20, type: 'platform' },
                { x: 1900, y: 340, w: 40, h: 40, type: 'enemy', range: 60, speed: 12, currentX: 1900, startX: 1900, dir: 1, isDead: false },
                { x: 2180, y: 320, w: 80, h: 20, type: 'platform' },
                { x: 2360, y: 250, w: 80, h: 20, type: 'platform' },
                { x: 2380, y: 210, w: 40, h: 40, type: 'enemy', range: 25, speed: 8, currentX: 2380, startX: 2380, dir: 1, isDead: false },
                { x: 2540, y: 180, w: 100, h: 20, type: 'platform' },
                { x: 2740, y: 120, w: 120, h: 20, type: 'platform' },
                { x: 2770, y: 80, w: 40, h: 40, type: 'enemy', range: 40, speed: 9, currentX: 2770, startX: 2770, dir: -1, isDead: false },
                { x: 2960, y: 180, w: 70, h: 20, type: 'platform' },
                { x: 3130, y: 240, w: 70, h: 20, type: 'platform' },
                { x: 3300, y: 300, w: 70, h: 20, type: 'platform' },
                { x: 3300, y: 260, w: 40, h: 40, type: 'enemy', range: 20, speed: 14, currentX: 3300, startX: 3300, dir: 1, isDead: false },
                { x: 3500, y: 380, w: 500, h: 20, type: 'platform' },
                { x: 3550, y: 340, w: 40, h: 40, type: 'enemy', range: 150, speed: 13, currentX: 3550, startX: 3550, dir: 1, isDead: false },
                { x: 3950, y: 300, w: 40, h: 40, type: 'goal' }
            ]},
            // LEVEL 9: BOSS FIGHT - "THE TERMINATOR"
            { width: 4200, startX: 50, startY: 300, isBoss: true,
              bossData: { x: 3850, y: 160, w: 150, h: 200, maxHp: 5, hp: 5 },
              objects: [
                // Starting safe zone
                { x: 0, y: 380, w: 250, h: 20, type: 'platform' },
                // Lava sea across the entire level
                { x: 250, y: 380, w: 3700, h: 20, type: 'lava' },
                // === PARKOUR SECTION 1: Climb to first core ===
                { x: 300, y: 320, w: 100, h: 20, type: 'platform' },
                { x: 470, y: 260, w: 80, h: 20, type: 'platform' },
                { x: 620, y: 190, w: 100, h: 20, type: 'platform' },
                // Enemy guarding the climb
                { x: 640, y: 150, w: 40, h: 40, type: 'enemy', range: 40, speed: 5, currentX: 640, startX: 640, dir: 1, isDead: false },
                // CORE 1 - at the top of the first climb
                { x: 630, y: 150, w: 60, h: 20, type: 'weakpoint', isUsed: false },
                // === PARKOUR SECTION 2: Cross to second core ===
                { x: 790, y: 260, w: 80, h: 20, type: 'platform' },
                { x: 950, y: 320, w: 80, h: 20, type: 'platform' },
                { x: 1100, y: 260, w: 80, h: 20, type: 'platform' },
                { x: 1260, y: 190, w: 100, h: 20, type: 'platform' },
                // Two enemies on the path
                { x: 970, y: 280, w: 40, h: 40, type: 'enemy', range: 30, speed: 8, currentX: 970, startX: 970, dir: -1, isDead: false },
                { x: 1280, y: 150, w: 40, h: 40, type: 'enemy', range: 40, speed: 6, currentX: 1280, startX: 1280, dir: 1, isDead: false },
                // CORE 2
                { x: 1270, y: 150, w: 60, h: 20, type: 'weakpoint', isUsed: false },
                // === PARKOUR SECTION 3: Extreme vertical climb ===
                { x: 1430, y: 280, w: 70, h: 20, type: 'platform' },
                { x: 1570, y: 220, w: 70, h: 20, type: 'platform' },
                { x: 1720, y: 150, w: 70, h: 20, type: 'platform' },
                { x: 1880, y: 90, w: 80, h: 20, type: 'platform' },
                // Fast enemy at the peak
                { x: 1890, y: 50, w: 40, h: 40, type: 'enemy', range: 30, speed: 10, currentX: 1890, startX: 1890, dir: 1, isDead: false },
                // CORE 3 - highest point
                { x: 1890, y: 50, w: 60, h: 20, type: 'weakpoint', isUsed: false },
                // === PARKOUR SECTION 4: Descending gauntlet ===
                { x: 2060, y: 160, w: 70, h: 20, type: 'platform' },
                { x: 2210, y: 240, w: 70, h: 20, type: 'platform' },
                { x: 2370, y: 310, w: 80, h: 20, type: 'platform' },
                { x: 2530, y: 240, w: 80, h: 20, type: 'platform' },
                { x: 2690, y: 170, w: 90, h: 20, type: 'platform' },
                // Enemies on the descent
                { x: 2230, y: 200, w: 40, h: 40, type: 'enemy', range: 25, speed: 9, currentX: 2230, startX: 2230, dir: -1, isDead: false },
                { x: 2390, y: 270, w: 40, h: 40, type: 'enemy', range: 30, speed: 11, currentX: 2390, startX: 2390, dir: 1, isDead: false },
                { x: 2710, y: 130, w: 40, h: 40, type: 'enemy', range: 35, speed: 7, currentX: 2710, startX: 2710, dir: 1, isDead: false },
                // CORE 4
                { x: 2700, y: 130, w: 60, h: 20, type: 'weakpoint', isUsed: false },
                // === PARKOUR SECTION 5: Final approach to the boss ===
                { x: 2870, y: 250, w: 70, h: 20, type: 'platform' },
                { x: 3030, y: 180, w: 70, h: 20, type: 'platform' },
                { x: 3190, y: 120, w: 70, h: 20, type: 'platform' },
                { x: 3350, y: 180, w: 80, h: 20, type: 'platform' },
                { x: 3510, y: 250, w: 80, h: 20, type: 'platform' },
                { x: 3670, y: 180, w: 90, h: 20, type: 'platform' },
                // Fast enemies near the boss
                { x: 3050, y: 140, w: 40, h: 40, type: 'enemy', range: 25, speed: 12, currentX: 3050, startX: 3050, dir: 1, isDead: false },
                { x: 3370, y: 140, w: 40, h: 40, type: 'enemy', range: 30, speed: 10, currentX: 3370, startX: 3370, dir: -1, isDead: false },
                { x: 3690, y: 140, w: 40, h: 40, type: 'enemy', range: 35, speed: 13, currentX: 3690, startX: 3690, dir: 1, isDead: false },
                // CORE 5 - right near the boss
                { x: 3680, y: 140, w: 60, h: 20, type: 'weakpoint', isUsed: false },
                // Boss platform and goal (goal only works after boss defeated)
                { x: 3950, y: 380, w: 250, h: 20, type: 'platform' },
                { x: 4100, y: 300, w: 40, h: 40, type: 'boss_goal' }
            ]},
            // LEVEL 10: "Aftershock" - Post-boss warmup, tricky lava gaps with moving enemies
            { width: 2800, startX: 50, startY: 300, objects: [
                { x: 0, y: 380, w: 250, h: 20, type: 'platform' },
                { x: 250, y: 390, w: 200, h: 10, type: 'lava' },
                { x: 450, y: 350, w: 120, h: 20, type: 'platform' },
                { x: 470, y: 310, w: 40, h: 40, type: 'enemy', range: 40, speed: 6, currentX: 470, startX: 470, dir: 1, isDead: false },
                { x: 570, y: 390, w: 180, h: 10, type: 'lava' },
                { x: 750, y: 300, w: 100, h: 20, type: 'platform' },
                { x: 850, y: 390, w: 250, h: 10, type: 'lava' },
                { x: 950, y: 240, w: 80, h: 20, type: 'platform' },
                { x: 1100, y: 180, w: 100, h: 20, type: 'platform' },
                { x: 1120, y: 140, w: 40, h: 40, type: 'enemy', range: 35, speed: 8, currentX: 1120, startX: 1120, dir: -1, isDead: false },
                { x: 1300, y: 250, w: 80, h: 20, type: 'platform' },
                { x: 1450, y: 320, w: 120, h: 20, type: 'platform' },
                { x: 1470, y: 280, w: 40, h: 40, type: 'enemy', range: 40, speed: 10, currentX: 1470, startX: 1470, dir: 1, isDead: false },
                { x: 1570, y: 390, w: 300, h: 10, type: 'lava' },
                { x: 1650, y: 250, w: 80, h: 20, type: 'platform' },
                { x: 1820, y: 180, w: 80, h: 20, type: 'platform' },
                { x: 1990, y: 250, w: 100, h: 20, type: 'platform' },
                { x: 2010, y: 210, w: 40, h: 40, type: 'enemy', range: 35, speed: 9, currentX: 2010, startX: 2010, dir: -1, isDead: false },
                { x: 2180, y: 320, w: 120, h: 20, type: 'platform' },
                { x: 2300, y: 390, w: 200, h: 10, type: 'lava' },
                { x: 2500, y: 380, w: 300, h: 20, type: 'platform' },
                { x: 2750, y: 300, w: 40, h: 40, type: 'goal' }
            ]},
            // LEVEL 11: "Neon Highways" - Fast horizontal run, narrow platforms, speedy enemies
            { width: 3600, startX: 50, startY: 300, objects: [
                { x: 0, y: 380, w: 200, h: 20, type: 'platform' },
                { x: 200, y: 390, w: 3200, h: 10, type: 'lava' },
                { x: 280, y: 340, w: 70, h: 20, type: 'platform' },
                { x: 420, y: 300, w: 70, h: 20, type: 'platform' },
                { x: 560, y: 260, w: 70, h: 20, type: 'platform' },
                { x: 580, y: 220, w: 40, h: 40, type: 'enemy', range: 20, speed: 10, currentX: 580, startX: 580, dir: 1, isDead: false },
                { x: 700, y: 300, w: 60, h: 20, type: 'platform' },
                { x: 830, y: 340, w: 60, h: 20, type: 'platform' },
                { x: 960, y: 280, w: 60, h: 20, type: 'platform' },
                { x: 980, y: 240, w: 40, h: 40, type: 'enemy', range: 15, speed: 12, currentX: 980, startX: 980, dir: -1, isDead: false },
                { x: 1090, y: 220, w: 60, h: 20, type: 'platform' },
                { x: 1220, y: 260, w: 60, h: 20, type: 'platform' },
                { x: 1350, y: 320, w: 60, h: 20, type: 'platform' },
                { x: 1370, y: 280, w: 40, h: 40, type: 'enemy', range: 15, speed: 14, currentX: 1370, startX: 1370, dir: 1, isDead: false },
                { x: 1480, y: 260, w: 50, h: 20, type: 'platform' },
                { x: 1600, y: 200, w: 50, h: 20, type: 'platform' },
                { x: 1720, y: 260, w: 50, h: 20, type: 'platform' },
                { x: 1840, y: 320, w: 50, h: 20, type: 'platform' },
                { x: 1860, y: 280, w: 40, h: 40, type: 'enemy', range: 10, speed: 13, currentX: 1860, startX: 1860, dir: -1, isDead: false },
                { x: 1960, y: 260, w: 60, h: 20, type: 'platform' },
                { x: 2090, y: 200, w: 60, h: 20, type: 'platform' },
                { x: 2110, y: 160, w: 40, h: 40, type: 'enemy', range: 15, speed: 11, currentX: 2110, startX: 2110, dir: 1, isDead: false },
                { x: 2220, y: 260, w: 60, h: 20, type: 'platform' },
                { x: 2350, y: 320, w: 60, h: 20, type: 'platform' },
                { x: 2480, y: 260, w: 50, h: 20, type: 'platform' },
                { x: 2600, y: 200, w: 50, h: 20, type: 'platform' },
                { x: 2620, y: 160, w: 40, h: 40, type: 'enemy', range: 10, speed: 15, currentX: 2620, startX: 2620, dir: -1, isDead: false },
                { x: 2720, y: 260, w: 60, h: 20, type: 'platform' },
                { x: 2860, y: 320, w: 60, h: 20, type: 'platform' },
                { x: 3000, y: 260, w: 60, h: 20, type: 'platform' },
                { x: 3140, y: 200, w: 60, h: 20, type: 'platform' },
                { x: 3160, y: 160, w: 40, h: 40, type: 'enemy', range: 15, speed: 14, currentX: 3160, startX: 3160, dir: 1, isDead: false },
                { x: 3280, y: 300, w: 70, h: 20, type: 'platform' },
                { x: 3400, y: 380, w: 200, h: 20, type: 'platform' },
                { x: 3550, y: 300, w: 40, h: 40, type: 'goal' }
            ]},
            // LEVEL 12: "Vertical Limit" - Extreme vertical climbing and descending
            { width: 3200, startX: 50, startY: 300, objects: [
                { x: 0, y: 380, w: 200, h: 20, type: 'platform' },
                { x: 200, y: 390, w: 2580, h: 10, type: 'lava' },
                // Ascent
                { x: 280, y: 320, w: 80, h: 20, type: 'platform' },
                { x: 380, y: 250, w: 70, h: 20, type: 'platform' },
                { x: 480, y: 180, w: 70, h: 20, type: 'platform' },
                { x: 500, y: 140, w: 40, h: 40, type: 'enemy', range: 20, speed: 7, currentX: 500, startX: 500, dir: 1, isDead: false },
                { x: 580, y: 110, w: 70, h: 20, type: 'platform' },
                { x: 700, y: 60, w: 80, h: 20, type: 'platform' },
                { x: 720, y: 20, w: 40, h: 40, type: 'enemy', range: 25, speed: 9, currentX: 720, startX: 720, dir: -1, isDead: false },
                // Traverse at the top
                { x: 850, y: 80, w: 60, h: 20, type: 'platform' },
                { x: 980, y: 50, w: 60, h: 20, type: 'platform' },
                { x: 1110, y: 80, w: 60, h: 20, type: 'platform' },
                { x: 1130, y: 40, w: 40, h: 40, type: 'enemy', range: 15, speed: 11, currentX: 1130, startX: 1130, dir: 1, isDead: false },
                // Descent
                { x: 1240, y: 140, w: 70, h: 20, type: 'platform' },
                { x: 1360, y: 200, w: 70, h: 20, type: 'platform' },
                { x: 1380, y: 160, w: 40, h: 40, type: 'enemy', range: 20, speed: 10, currentX: 1380, startX: 1380, dir: -1, isDead: false },
                { x: 1480, y: 270, w: 70, h: 20, type: 'platform' },
                { x: 1600, y: 340, w: 80, h: 20, type: 'platform' },
                // Second ascent - harder
                { x: 1720, y: 270, w: 60, h: 20, type: 'platform' },
                { x: 1830, y: 200, w: 60, h: 20, type: 'platform' },
                { x: 1850, y: 160, w: 40, h: 40, type: 'enemy', range: 15, speed: 12, currentX: 1850, startX: 1850, dir: 1, isDead: false },
                { x: 1940, y: 130, w: 60, h: 20, type: 'platform' },
                { x: 2060, y: 70, w: 70, h: 20, type: 'platform' },
                { x: 2080, y: 30, w: 40, h: 40, type: 'enemy', range: 20, speed: 13, currentX: 2080, startX: 2080, dir: -1, isDead: false },
                // Final traverse and descent
                { x: 2200, y: 50, w: 50, h: 20, type: 'platform' },
                { x: 2320, y: 90, w: 50, h: 20, type: 'platform' },
                { x: 2340, y: 50, w: 40, h: 40, type: 'enemy', range: 10, speed: 14, currentX: 2340, startX: 2340, dir: 1, isDead: false },
                { x: 2440, y: 150, w: 60, h: 20, type: 'platform' },
                { x: 2560, y: 230, w: 60, h: 20, type: 'platform' },
                { x: 2680, y: 310, w: 70, h: 20, type: 'platform' },
                { x: 2800, y: 380, w: 200, h: 20, type: 'platform' },
                { x: 3000, y: 380, w: 200, h: 20, type: 'platform' },
                { x: 3150, y: 300, w: 40, h: 40, type: 'goal' }
            ]},
            // LEVEL 13: "Inferno" - Lava everywhere, tiny platforms, fast enemies
            { width: 3800, startX: 50, startY: 300, objects: [
                { x: 0, y: 380, w: 150, h: 20, type: 'platform' },
                { x: 150, y: 385, w: 3250, h: 15, type: 'lava' },
                { x: 220, y: 320, w: 55, h: 20, type: 'platform' },
                { x: 340, y: 260, w: 55, h: 20, type: 'platform' },
                { x: 360, y: 220, w: 40, h: 40, type: 'enemy', range: 10, speed: 10, currentX: 360, startX: 360, dir: 1, isDead: false },
                { x: 460, y: 300, w: 55, h: 20, type: 'platform' },
                { x: 580, y: 240, w: 55, h: 20, type: 'platform' },
                { x: 700, y: 180, w: 55, h: 20, type: 'platform' },
                { x: 720, y: 140, w: 40, h: 40, type: 'enemy', range: 10, speed: 12, currentX: 720, startX: 720, dir: -1, isDead: false },
                { x: 820, y: 260, w: 55, h: 20, type: 'platform' },
                { x: 940, y: 320, w: 55, h: 20, type: 'platform' },
                { x: 960, y: 280, w: 40, h: 40, type: 'enemy', range: 10, speed: 14, currentX: 960, startX: 960, dir: 1, isDead: false },
                { x: 1060, y: 240, w: 50, h: 20, type: 'platform' },
                { x: 1170, y: 170, w: 50, h: 20, type: 'platform' },
                { x: 1280, y: 240, w: 50, h: 20, type: 'platform' },
                { x: 1300, y: 200, w: 40, h: 40, type: 'enemy', range: 10, speed: 13, currentX: 1300, startX: 1300, dir: -1, isDead: false },
                { x: 1390, y: 310, w: 50, h: 20, type: 'platform' },
                { x: 1500, y: 250, w: 50, h: 20, type: 'platform' },
                { x: 1610, y: 180, w: 50, h: 20, type: 'platform' },
                { x: 1630, y: 140, w: 40, h: 40, type: 'enemy', range: 10, speed: 15, currentX: 1630, startX: 1630, dir: 1, isDead: false },
                { x: 1720, y: 260, w: 50, h: 20, type: 'platform' },
                { x: 1840, y: 330, w: 50, h: 20, type: 'platform' },
                { x: 1960, y: 270, w: 45, h: 20, type: 'platform' },
                { x: 2070, y: 200, w: 45, h: 20, type: 'platform' },
                { x: 2090, y: 160, w: 40, h: 40, type: 'enemy', range: 8, speed: 14, currentX: 2090, startX: 2090, dir: -1, isDead: false },
                { x: 2180, y: 280, w: 45, h: 20, type: 'platform' },
                { x: 2290, y: 340, w: 45, h: 20, type: 'platform' },
                { x: 2400, y: 270, w: 45, h: 20, type: 'platform' },
                { x: 2420, y: 230, w: 40, h: 40, type: 'enemy', range: 8, speed: 15, currentX: 2420, startX: 2420, dir: 1, isDead: false },
                { x: 2510, y: 200, w: 45, h: 20, type: 'platform' },
                { x: 2620, y: 140, w: 50, h: 20, type: 'platform' },
                { x: 2740, y: 200, w: 50, h: 20, type: 'platform' },
                { x: 2860, y: 270, w: 50, h: 20, type: 'platform' },
                { x: 2980, y: 340, w: 50, h: 20, type: 'platform' },
                { x: 3000, y: 300, w: 40, h: 40, type: 'enemy', range: 10, speed: 16, currentX: 3000, startX: 3000, dir: -1, isDead: false },
                { x: 3100, y: 270, w: 50, h: 20, type: 'platform' },
                { x: 3250, y: 340, w: 60, h: 20, type: 'platform' },
                { x: 3400, y: 380, w: 200, h: 20, type: 'platform' },
                { x: 3600, y: 380, w: 200, h: 20, type: 'platform' },
                { x: 3750, y: 300, w: 40, h: 40, type: 'goal' }
            ]},
            // LEVEL 14: "Phantom Run" - Long gauntlet with dense enemy patrols and mixed hazards
            { width: 4200, startX: 50, startY: 300, objects: [
                { x: 0, y: 380, w: 300, h: 20, type: 'platform' },
                { x: 150, y: 340, w: 40, h: 40, type: 'enemy', range: 60, speed: 8, currentX: 150, startX: 150, dir: 1, isDead: false },
                { x: 300, y: 385, w: 200, h: 15, type: 'lava' },
                { x: 500, y: 380, w: 200, h: 20, type: 'platform' },
                { x: 550, y: 340, w: 40, h: 40, type: 'enemy', range: 50, speed: 12, currentX: 550, startX: 550, dir: -1, isDead: false },
                { x: 700, y: 385, w: 150, h: 15, type: 'lava' },
                { x: 850, y: 320, w: 80, h: 20, type: 'platform' },
                { x: 870, y: 280, w: 40, h: 40, type: 'enemy', range: 20, speed: 10, currentX: 870, startX: 870, dir: 1, isDead: false },
                { x: 1000, y: 260, w: 70, h: 20, type: 'platform' },
                { x: 1130, y: 200, w: 70, h: 20, type: 'platform' },
                { x: 1150, y: 160, w: 40, h: 40, type: 'enemy', range: 15, speed: 11, currentX: 1150, startX: 1150, dir: -1, isDead: false },
                { x: 1260, y: 260, w: 80, h: 20, type: 'platform' },
                { x: 1400, y: 380, w: 250, h: 20, type: 'platform' },
                { x: 1500, y: 340, w: 40, h: 40, type: 'enemy', range: 50, speed: 14, currentX: 1500, startX: 1500, dir: 1, isDead: false },
                { x: 1650, y: 385, w: 250, h: 15, type: 'lava' },
                { x: 1700, y: 280, w: 60, h: 20, type: 'platform' },
                { x: 1830, y: 220, w: 60, h: 20, type: 'platform' },
                { x: 1850, y: 180, w: 40, h: 40, type: 'enemy', range: 15, speed: 13, currentX: 1850, startX: 1850, dir: -1, isDead: false },
                { x: 1960, y: 300, w: 60, h: 20, type: 'platform' },
                { x: 2090, y: 380, w: 200, h: 20, type: 'platform' },
                { x: 2150, y: 340, w: 40, h: 40, type: 'enemy', range: 40, speed: 15, currentX: 2150, startX: 2150, dir: 1, isDead: false },
                { x: 2290, y: 385, w: 200, h: 15, type: 'lava' },
                { x: 2340, y: 300, w: 60, h: 20, type: 'platform' },
                { x: 2460, y: 240, w: 60, h: 20, type: 'platform' },
                { x: 2480, y: 200, w: 40, h: 40, type: 'enemy', range: 15, speed: 14, currentX: 2480, startX: 2480, dir: -1, isDead: false },
                { x: 2580, y: 180, w: 60, h: 20, type: 'platform' },
                { x: 2700, y: 240, w: 70, h: 20, type: 'platform' },
                { x: 2830, y: 310, w: 70, h: 20, type: 'platform' },
                { x: 2850, y: 270, w: 40, h: 40, type: 'enemy', range: 20, speed: 15, currentX: 2850, startX: 2850, dir: 1, isDead: false },
                { x: 2960, y: 380, w: 200, h: 20, type: 'platform' },
                { x: 3000, y: 340, w: 40, h: 40, type: 'enemy', range: 60, speed: 16, currentX: 3000, startX: 3000, dir: -1, isDead: false },
                { x: 3160, y: 385, w: 250, h: 15, type: 'lava' },
                { x: 3220, y: 280, w: 60, h: 20, type: 'platform' },
                { x: 3350, y: 220, w: 60, h: 20, type: 'platform' },
                { x: 3370, y: 180, w: 40, h: 40, type: 'enemy', range: 15, speed: 16, currentX: 3370, startX: 3370, dir: 1, isDead: false },
                { x: 3470, y: 300, w: 70, h: 20, type: 'platform' },
                { x: 3600, y: 380, w: 200, h: 20, type: 'platform' },
                { x: 3800, y: 380, w: 200, h: 20, type: 'platform' },
                { x: 3850, y: 340, w: 40, h: 40, type: 'enemy', range: 60, speed: 14, currentX: 3850, startX: 3850, dir: 1, isDead: false },
                { x: 4000, y: 380, w: 200, h: 20, type: 'platform' },
                { x: 4150, y: 300, w: 40, h: 40, type: 'goal' }
            ]},
            // LEVEL 15: "Sky Fortress" - High altitude platforming, long gaps, enemies on every platform
            { width: 4000, startX: 50, startY: 300, objects: [
                { x: 0, y: 380, w: 200, h: 20, type: 'platform' },
                { x: 200, y: 390, w: 3200, h: 10, type: 'lava' },
                // Rising stairway
                { x: 280, y: 320, w: 70, h: 20, type: 'platform' },
                { x: 420, y: 260, w: 70, h: 20, type: 'platform' },
                { x: 440, y: 220, w: 40, h: 40, type: 'enemy', range: 15, speed: 9, currentX: 440, startX: 440, dir: 1, isDead: false },
                { x: 560, y: 190, w: 70, h: 20, type: 'platform' },
                { x: 700, y: 130, w: 80, h: 20, type: 'platform' },
                { x: 720, y: 90, w: 40, h: 40, type: 'enemy', range: 20, speed: 11, currentX: 720, startX: 720, dir: -1, isDead: false },
                { x: 850, y: 80, w: 70, h: 20, type: 'platform' },
                // Sky bridge section
                { x: 990, y: 60, w: 60, h: 20, type: 'platform' },
                { x: 1010, y: 20, w: 40, h: 40, type: 'enemy', range: 10, speed: 12, currentX: 1010, startX: 1010, dir: 1, isDead: false },
                { x: 1120, y: 80, w: 60, h: 20, type: 'platform' },
                { x: 1250, y: 50, w: 60, h: 20, type: 'platform' },
                { x: 1380, y: 80, w: 60, h: 20, type: 'platform' },
                { x: 1400, y: 40, w: 40, h: 40, type: 'enemy', range: 10, speed: 13, currentX: 1400, startX: 1400, dir: -1, isDead: false },
                { x: 1510, y: 50, w: 60, h: 20, type: 'platform' },
                // Descent with enemies
                { x: 1640, y: 100, w: 60, h: 20, type: 'platform' },
                { x: 1660, y: 60, w: 40, h: 40, type: 'enemy', range: 10, speed: 14, currentX: 1660, startX: 1660, dir: 1, isDead: false },
                { x: 1770, y: 160, w: 60, h: 20, type: 'platform' },
                { x: 1900, y: 220, w: 60, h: 20, type: 'platform' },
                { x: 1920, y: 180, w: 40, h: 40, type: 'enemy', range: 10, speed: 12, currentX: 1920, startX: 1920, dir: -1, isDead: false },
                // Second sky section
                { x: 2040, y: 160, w: 60, h: 20, type: 'platform' },
                { x: 2170, y: 100, w: 60, h: 20, type: 'platform' },
                { x: 2300, y: 60, w: 70, h: 20, type: 'platform' },
                { x: 2320, y: 20, w: 40, h: 40, type: 'enemy', range: 15, speed: 15, currentX: 2320, startX: 2320, dir: 1, isDead: false },
                { x: 2440, y: 90, w: 60, h: 20, type: 'platform' },
                { x: 2570, y: 50, w: 60, h: 20, type: 'platform' },
                { x: 2590, y: 10, w: 40, h: 40, type: 'enemy', range: 10, speed: 16, currentX: 2590, startX: 2590, dir: -1, isDead: false },
                { x: 2700, y: 100, w: 60, h: 20, type: 'platform' },
                // Final descent
                { x: 2830, y: 160, w: 60, h: 20, type: 'platform' },
                { x: 2960, y: 230, w: 60, h: 20, type: 'platform' },
                { x: 2980, y: 190, w: 40, h: 40, type: 'enemy', range: 10, speed: 14, currentX: 2980, startX: 2980, dir: 1, isDead: false },
                { x: 3100, y: 300, w: 70, h: 20, type: 'platform' },
                { x: 3240, y: 340, w: 70, h: 20, type: 'platform' },
                { x: 3260, y: 300, w: 40, h: 40, type: 'enemy', range: 20, speed: 13, currentX: 3260, startX: 3260, dir: -1, isDead: false },
                { x: 3400, y: 380, w: 200, h: 20, type: 'platform' },
                { x: 3600, y: 380, w: 200, h: 20, type: 'platform' },
                { x: 3800, y: 380, w: 200, h: 20, type: 'platform' },
                { x: 3950, y: 300, w: 40, h: 40, type: 'goal' }
            ]},
            // LEVEL 16: "Death Spiral" - Zigzag pattern with lava pits and relentless enemies
            { width: 4400, startX: 50, startY: 300, objects: [
                { x: 0, y: 380, w: 200, h: 20, type: 'platform' },
                { x: 100, y: 340, w: 40, h: 40, type: 'enemy', range: 40, speed: 10, currentX: 100, startX: 100, dir: 1, isDead: false },
                { x: 200, y: 385, w: 150, h: 15, type: 'lava' },
                // Zigzag up
                { x: 350, y: 320, w: 60, h: 20, type: 'platform' },
                { x: 370, y: 280, w: 40, h: 40, type: 'enemy', range: 10, speed: 12, currentX: 370, startX: 370, dir: -1, isDead: false },
                { x: 480, y: 250, w: 60, h: 20, type: 'platform' },
                { x: 610, y: 180, w: 60, h: 20, type: 'platform' },
                { x: 630, y: 140, w: 40, h: 40, type: 'enemy', range: 10, speed: 13, currentX: 630, startX: 630, dir: 1, isDead: false },
                { x: 740, y: 120, w: 60, h: 20, type: 'platform' },
                { x: 870, y: 60, w: 70, h: 20, type: 'platform' },
                // Zigzag down
                { x: 1000, y: 120, w: 60, h: 20, type: 'platform' },
                { x: 1020, y: 80, w: 40, h: 40, type: 'enemy', range: 10, speed: 14, currentX: 1020, startX: 1020, dir: -1, isDead: false },
                { x: 1130, y: 190, w: 60, h: 20, type: 'platform' },
                { x: 1260, y: 260, w: 60, h: 20, type: 'platform' },
                { x: 1280, y: 220, w: 40, h: 40, type: 'enemy', range: 10, speed: 15, currentX: 1280, startX: 1280, dir: 1, isDead: false },
                { x: 1390, y: 330, w: 60, h: 20, type: 'platform' },
                { x: 1450, y: 385, w: 70, h: 15, type: 'lava' },
                // Flat gauntlet
                { x: 1520, y: 380, w: 200, h: 20, type: 'platform' },
                { x: 1550, y: 340, w: 40, h: 40, type: 'enemy', range: 50, speed: 16, currentX: 1550, startX: 1550, dir: 1, isDead: false },
                { x: 1650, y: 340, w: 40, h: 40, type: 'enemy', range: 30, speed: 14, currentX: 1650, startX: 1650, dir: -1, isDead: false },
                { x: 1720, y: 385, w: 150, h: 15, type: 'lava' },
                // Second zigzag up
                { x: 1870, y: 320, w: 55, h: 20, type: 'platform' },
                { x: 1990, y: 250, w: 55, h: 20, type: 'platform' },
                { x: 2010, y: 210, w: 40, h: 40, type: 'enemy', range: 10, speed: 15, currentX: 2010, startX: 2010, dir: 1, isDead: false },
                { x: 2110, y: 180, w: 55, h: 20, type: 'platform' },
                { x: 2230, y: 110, w: 60, h: 20, type: 'platform' },
                { x: 2250, y: 70, w: 40, h: 40, type: 'enemy', range: 10, speed: 16, currentX: 2250, startX: 2250, dir: -1, isDead: false },
                { x: 2360, y: 50, w: 60, h: 20, type: 'platform' },
                // Second zigzag down
                { x: 2490, y: 110, w: 55, h: 20, type: 'platform' },
                { x: 2610, y: 180, w: 55, h: 20, type: 'platform' },
                { x: 2630, y: 140, w: 40, h: 40, type: 'enemy', range: 10, speed: 16, currentX: 2630, startX: 2630, dir: 1, isDead: false },
                { x: 2730, y: 250, w: 55, h: 20, type: 'platform' },
                { x: 2850, y: 320, w: 60, h: 20, type: 'platform' },
                { x: 2870, y: 280, w: 40, h: 40, type: 'enemy', range: 10, speed: 15, currentX: 2870, startX: 2870, dir: -1, isDead: false },
                { x: 2910, y: 385, w: 100, h: 15, type: 'lava' },
                // Final flat gauntlet
                { x: 3010, y: 380, w: 300, h: 20, type: 'platform' },
                { x: 3050, y: 340, w: 40, h: 40, type: 'enemy', range: 80, speed: 16, currentX: 3050, startX: 3050, dir: 1, isDead: false },
                { x: 3180, y: 340, w: 40, h: 40, type: 'enemy', range: 40, speed: 14, currentX: 3180, startX: 3180, dir: -1, isDead: false },
                { x: 3330, y: 385, w: 180, h: 15, type: 'lava' },
                { x: 3380, y: 300, w: 55, h: 20, type: 'platform' },
                { x: 3500, y: 240, w: 55, h: 20, type: 'platform' },
                { x: 3520, y: 200, w: 40, h: 40, type: 'enemy', range: 10, speed: 16, currentX: 3520, startX: 3520, dir: 1, isDead: false },
                { x: 3620, y: 310, w: 55, h: 20, type: 'platform' },
                { x: 3750, y: 380, w: 200, h: 20, type: 'platform' },
                { x: 3950, y: 380, w: 250, h: 20, type: 'platform' },
                { x: 4000, y: 340, w: 40, h: 40, type: 'enemy', range: 80, speed: 16, currentX: 4000, startX: 4000, dir: 1, isDead: false },
                { x: 4200, y: 380, w: 200, h: 20, type: 'platform' },
                { x: 4350, y: 300, w: 40, h: 40, type: 'goal' }
            ]},
            // LEVEL 17: "The Final Protocol" - Ultimate challenge, everything combined, brutal difficulty
            { width: 5000, startX: 50, startY: 300, objects: [
                { x: 0, y: 380, w: 180, h: 20, type: 'platform' },
                { x: 80, y: 340, w: 40, h: 40, type: 'enemy', range: 40, speed: 12, currentX: 80, startX: 80, dir: 1, isDead: false },
                { x: 180, y: 385, w: 200, h: 15, type: 'lava' },
                // Section 1: Rapid ascent
                { x: 380, y: 320, w: 50, h: 20, type: 'platform' },
                { x: 400, y: 280, w: 40, h: 40, type: 'enemy', range: 8, speed: 14, currentX: 400, startX: 400, dir: -1, isDead: false },
                { x: 500, y: 250, w: 50, h: 20, type: 'platform' },
                { x: 620, y: 180, w: 50, h: 20, type: 'platform' },
                { x: 640, y: 140, w: 40, h: 40, type: 'enemy', range: 8, speed: 15, currentX: 640, startX: 640, dir: 1, isDead: false },
                { x: 740, y: 110, w: 50, h: 20, type: 'platform' },
                { x: 860, y: 50, w: 60, h: 20, type: 'platform' },
                { x: 880, y: 10, w: 40, h: 40, type: 'enemy', range: 10, speed: 16, currentX: 880, startX: 880, dir: -1, isDead: false },
                // Section 2: Sky traverse over lava
                { x: 380, y: 390, w: 1200, h: 10, type: 'lava' },
                { x: 990, y: 80, w: 45, h: 20, type: 'platform' },
                { x: 1110, y: 50, w: 45, h: 20, type: 'platform' },
                { x: 1130, y: 10, w: 40, h: 40, type: 'enemy', range: 8, speed: 16, currentX: 1130, startX: 1130, dir: 1, isDead: false },
                { x: 1230, y: 80, w: 45, h: 20, type: 'platform' },
                { x: 1350, y: 130, w: 45, h: 20, type: 'platform' },
                { x: 1370, y: 90, w: 40, h: 40, type: 'enemy', range: 8, speed: 15, currentX: 1370, startX: 1370, dir: -1, isDead: false },
                // Section 3: Descent into gauntlet
                { x: 1470, y: 200, w: 50, h: 20, type: 'platform' },
                { x: 1580, y: 280, w: 50, h: 20, type: 'platform' },
                { x: 1580, y: 390, w: 300, h: 15, type: 'lava' },
                { x: 1700, y: 380, w: 200, h: 20, type: 'platform' },
                { x: 1730, y: 340, w: 40, h: 40, type: 'enemy', range: 50, speed: 16, currentX: 1730, startX: 1730, dir: 1, isDead: false },
                { x: 1830, y: 340, w: 40, h: 40, type: 'enemy', range: 30, speed: 14, currentX: 1830, startX: 1830, dir: -1, isDead: false },
                // Section 4: Narrow bridge over lava
                { x: 1900, y: 385, w: 600, h: 15, type: 'lava' },
                { x: 1960, y: 300, w: 45, h: 20, type: 'platform' },
                { x: 2070, y: 240, w: 45, h: 20, type: 'platform' },
                { x: 2090, y: 200, w: 40, h: 40, type: 'enemy', range: 8, speed: 16, currentX: 2090, startX: 2090, dir: 1, isDead: false },
                { x: 2180, y: 170, w: 45, h: 20, type: 'platform' },
                { x: 2290, y: 240, w: 45, h: 20, type: 'platform' },
                { x: 2310, y: 200, w: 40, h: 40, type: 'enemy', range: 8, speed: 15, currentX: 2310, startX: 2310, dir: -1, isDead: false },
                { x: 2400, y: 310, w: 50, h: 20, type: 'platform' },
                { x: 2500, y: 380, w: 150, h: 20, type: 'platform' },
                { x: 2530, y: 340, w: 40, h: 40, type: 'enemy', range: 40, speed: 16, currentX: 2530, startX: 2530, dir: 1, isDead: false },
                // Section 5: The nightmare climb
                { x: 2650, y: 390, w: 1000, h: 10, type: 'lava' },
                { x: 2720, y: 320, w: 45, h: 20, type: 'platform' },
                { x: 2830, y: 250, w: 45, h: 20, type: 'platform' },
                { x: 2850, y: 210, w: 40, h: 40, type: 'enemy', range: 8, speed: 16, currentX: 2850, startX: 2850, dir: -1, isDead: false },
                { x: 2940, y: 180, w: 45, h: 20, type: 'platform' },
                { x: 3050, y: 110, w: 50, h: 20, type: 'platform' },
                { x: 3070, y: 70, w: 40, h: 40, type: 'enemy', range: 10, speed: 16, currentX: 3070, startX: 3070, dir: 1, isDead: false },
                { x: 3170, y: 50, w: 50, h: 20, type: 'platform' },
                { x: 3290, y: 90, w: 45, h: 20, type: 'platform' },
                { x: 3310, y: 50, w: 40, h: 40, type: 'enemy', range: 8, speed: 16, currentX: 3310, startX: 3310, dir: -1, isDead: false },
                { x: 3400, y: 140, w: 45, h: 20, type: 'platform' },
                // Section 6: Final descent of doom
                { x: 3510, y: 210, w: 45, h: 20, type: 'platform' },
                { x: 3530, y: 170, w: 40, h: 40, type: 'enemy', range: 8, speed: 16, currentX: 3530, startX: 3530, dir: 1, isDead: false },
                { x: 3620, y: 280, w: 45, h: 20, type: 'platform' },
                { x: 3650, y: 387, w: 250, h: 15, type: 'lava' },
                { x: 3730, y: 340, w: 50, h: 20, type: 'platform' },
                { x: 3850, y: 380, w: 200, h: 20, type: 'platform' },
                { x: 3880, y: 340, w: 40, h: 40, type: 'enemy', range: 60, speed: 16, currentX: 3880, startX: 3880, dir: -1, isDead: false },
                { x: 3980, y: 340, w: 40, h: 40, type: 'enemy', range: 40, speed: 14, currentX: 3980, startX: 3980, dir: 1, isDead: false },
                { x: 4050, y: 385, w: 300, h: 15, type: 'lava' },
                { x: 4120, y: 300, w: 45, h: 20, type: 'platform' },
                { x: 4230, y: 240, w: 45, h: 20, type: 'platform' },
                { x: 4250, y: 200, w: 40, h: 40, type: 'enemy', range: 8, speed: 16, currentX: 4250, startX: 4250, dir: -1, isDead: false },
                { x: 4340, y: 310, w: 50, h: 20, type: 'platform' },
                { x: 4450, y: 380, w: 200, h: 20, type: 'platform' },
                { x: 4480, y: 340, w: 40, h: 40, type: 'enemy', range: 60, speed: 16, currentX: 4480, startX: 4480, dir: 1, isDead: false },
                { x: 4650, y: 380, w: 200, h: 20, type: 'platform' },
                { x: 4850, y: 380, w: 150, h: 20, type: 'platform' },
                { x: 4950, y: 300, w: 40, h: 40, type: 'goal' }
            ]},
            // LEVEL 18: BOSS FIGHT - "THE GLITCH QUEEN"
            { width: 5200, startX: 50, startY: 300, isBoss: true, bossType: 'queen',
              bossData: { x: 4850, y: 120, w: 130, h: 180, maxHp: 7, hp: 7 },
              objects: [
                // Starting safe zone
                { x: 0, y: 380, w: 200, h: 20, type: 'platform' },
                // Lava sea across the entire level
                { x: 200, y: 390, w: 4800, h: 10, type: 'lava' },
                // === SECTION 1: The Glitch Gauntlet ===
                { x: 270, y: 320, w: 50, h: 20, type: 'platform' },
                { x: 380, y: 250, w: 45, h: 20, type: 'platform' },
                { x: 400, y: 210, w: 40, h: 40, type: 'enemy', range: 8, speed: 12, currentX: 400, startX: 400, dir: 1, isDead: false },
                { x: 490, y: 180, w: 45, h: 20, type: 'platform' },
                { x: 600, y: 120, w: 50, h: 20, type: 'platform' },
                // GLITCH ORB 1 - top of first climb
                { x: 610, y: 95, w: 30, h: 25, type: 'glitch_orb', isUsed: false },
                // === SECTION 2: Descent into Chaos ===
                { x: 720, y: 180, w: 45, h: 20, type: 'platform' },
                { x: 740, y: 140, w: 40, h: 40, type: 'enemy', range: 8, speed: 14, currentX: 740, startX: 740, dir: -1, isDead: false },
                { x: 840, y: 250, w: 45, h: 20, type: 'platform' },
                { x: 950, y: 320, w: 50, h: 20, type: 'platform' },
                { x: 970, y: 280, w: 40, h: 40, type: 'enemy', range: 10, speed: 13, currentX: 970, startX: 970, dir: 1, isDead: false },
                { x: 1060, y: 250, w: 45, h: 20, type: 'platform' },
                { x: 1170, y: 180, w: 45, h: 20, type: 'platform' },
                // GLITCH ORB 2
                { x: 1180, y: 155, w: 30, h: 25, type: 'glitch_orb', isUsed: false },
                // === SECTION 3: The Razor's Edge ===
                { x: 1280, y: 130, w: 40, h: 20, type: 'platform' },
                { x: 1300, y: 90, w: 40, h: 40, type: 'enemy', range: 5, speed: 15, currentX: 1300, startX: 1300, dir: -1, isDead: false },
                { x: 1390, y: 80, w: 40, h: 20, type: 'platform' },
                { x: 1500, y: 50, w: 45, h: 20, type: 'platform' },
                { x: 1610, y: 80, w: 40, h: 20, type: 'platform' },
                { x: 1630, y: 40, w: 40, h: 40, type: 'enemy', range: 5, speed: 16, currentX: 1630, startX: 1630, dir: 1, isDead: false },
                { x: 1720, y: 130, w: 45, h: 20, type: 'platform' },
                // GLITCH ORB 3 - at the peak
                { x: 1510, y: 25, w: 30, h: 25, type: 'glitch_orb', isUsed: false },
                // === SECTION 4: Freefall Corridor ===
                { x: 1830, y: 200, w: 45, h: 20, type: 'platform' },
                { x: 1850, y: 160, w: 40, h: 40, type: 'enemy', range: 8, speed: 15, currentX: 1850, startX: 1850, dir: -1, isDead: false },
                { x: 1940, y: 280, w: 45, h: 20, type: 'platform' },
                { x: 2050, y: 340, w: 50, h: 20, type: 'platform' },
                { x: 2070, y: 300, w: 40, h: 40, type: 'enemy', range: 10, speed: 14, currentX: 2070, startX: 2070, dir: 1, isDead: false },
                { x: 2160, y: 270, w: 45, h: 20, type: 'platform' },
                { x: 2270, y: 200, w: 45, h: 20, type: 'platform' },
                // GLITCH ORB 4
                { x: 2280, y: 175, w: 30, h: 25, type: 'glitch_orb', isUsed: false },
                // === SECTION 5: The Nightmare Spire ===
                { x: 2380, y: 150, w: 40, h: 20, type: 'platform' },
                { x: 2400, y: 110, w: 40, h: 40, type: 'enemy', range: 5, speed: 16, currentX: 2400, startX: 2400, dir: -1, isDead: false },
                { x: 2490, y: 100, w: 40, h: 20, type: 'platform' },
                { x: 2600, y: 60, w: 45, h: 20, type: 'platform' },
                { x: 2620, y: 20, w: 40, h: 40, type: 'enemy', range: 5, speed: 16, currentX: 2620, startX: 2620, dir: 1, isDead: false },
                { x: 2710, y: 40, w: 40, h: 20, type: 'platform' },
                // GLITCH ORB 5 - highest point in the level
                { x: 2720, y: 15, w: 30, h: 25, type: 'glitch_orb', isUsed: false },
                // === SECTION 6: The Descent of Madness ===
                { x: 2820, y: 100, w: 40, h: 20, type: 'platform' },
                { x: 2930, y: 170, w: 40, h: 20, type: 'platform' },
                { x: 2950, y: 130, w: 40, h: 40, type: 'enemy', range: 5, speed: 16, currentX: 2950, startX: 2950, dir: -1, isDead: false },
                { x: 3040, y: 240, w: 45, h: 20, type: 'platform' },
                { x: 3150, y: 310, w: 45, h: 20, type: 'platform' },
                { x: 3170, y: 270, w: 40, h: 40, type: 'enemy', range: 8, speed: 15, currentX: 3170, startX: 3170, dir: 1, isDead: false },
                { x: 3260, y: 250, w: 40, h: 20, type: 'platform' },
                { x: 3370, y: 180, w: 40, h: 20, type: 'platform' },
                // GLITCH ORB 6
                { x: 3380, y: 155, w: 30, h: 25, type: 'glitch_orb', isUsed: false },
                // === SECTION 7: Final Approach - The Queen's Domain ===
                { x: 3480, y: 130, w: 40, h: 20, type: 'platform' },
                { x: 3500, y: 90, w: 40, h: 40, type: 'enemy', range: 5, speed: 16, currentX: 3500, startX: 3500, dir: -1, isDead: false },
                { x: 3590, y: 90, w: 40, h: 20, type: 'platform' },
                { x: 3700, y: 60, w: 45, h: 20, type: 'platform' },
                { x: 3810, y: 100, w: 40, h: 20, type: 'platform' },
                { x: 3830, y: 60, w: 40, h: 40, type: 'enemy', range: 5, speed: 16, currentX: 3830, startX: 3830, dir: 1, isDead: false },
                { x: 3920, y: 160, w: 40, h: 20, type: 'platform' },
                { x: 4030, y: 230, w: 45, h: 20, type: 'platform' },
                { x: 4050, y: 190, w: 40, h: 40, type: 'enemy', range: 8, speed: 16, currentX: 4050, startX: 4050, dir: -1, isDead: false },
                { x: 4140, y: 300, w: 45, h: 20, type: 'platform' },
                { x: 4250, y: 240, w: 40, h: 20, type: 'platform' },
                { x: 4360, y: 170, w: 40, h: 20, type: 'platform' },
                { x: 4380, y: 130, w: 40, h: 40, type: 'enemy', range: 5, speed: 16, currentX: 4380, startX: 4380, dir: 1, isDead: false },
                { x: 4470, y: 120, w: 45, h: 20, type: 'platform' },
                // GLITCH ORB 7 - right before the boss
                { x: 4480, y: 95, w: 30, h: 25, type: 'glitch_orb', isUsed: false },
                // Boss platform and exit
                { x: 4600, y: 180, w: 60, h: 20, type: 'platform' },
                { x: 4700, y: 250, w: 60, h: 20, type: 'platform' },
                { x: 5000, y: 380, w: 200, h: 20, type: 'platform' },
                { x: 5100, y: 300, w: 40, h: 40, type: 'boss_goal' }
            ]}
        ];
        function triggerDeath() {
            if (deathTimer > 0) return;
            deathTimer = 60; player.visible = false;
            // Reset speedrun timer only if you die on Level 1
            if (currentLevel === 0) {
                stopwatchStarted = false;
                stopwatchStartTime = 0;
                stopwatchElapsed = 0;
                stopwatchFinal = 0;
                gameFinished = false;
            }
            createExplosion(player.x + player.width/2, player.y + player.height/2, player.color, 25);
            triggerScreenShake(12);
            playSfxDeath();
        }
        function loadLevel(index) {
            if (index >= levels.length) {
                let timeText = '';
                if (stopwatchStarted) {
                    gameFinished = true;
                    stopwatchFinal = performance.now() - stopwatchStartTime;
                    timeText = " | TIME " + formatTime(stopwatchFinal);
                }
                alert("MISSION COMPLETE: FINAL SCORE " + score + timeText);
                currentLevel = 0; index = 0; score = 0;
                // Reset for next run
                stopwatchStarted = false;
                stopwatchStartTime = 0;
                stopwatchElapsed = 0;
                stopwatchFinal = 0;
                gameFinished = false;
            }
            const lvl = levels[index];
            player.x = lvl.startX; player.y = lvl.startY;
            player.oldY = lvl.startY; player.velX = 0; player.velY = 0;
            player.visible = true; deathTimer = 0; hangTime = 0; particles = []; trails = [];
            lvl.objects.forEach(obj => {
                if (obj.type === 'enemy') obj.isDead = false;
                if (obj.type === 'weakpoint') obj.isUsed = false;
                if (obj.type === 'glitch_orb') obj.isUsed = false;
            });
            // Boss initialization
            if (lvl.isBoss && lvl.bossData) {
                bossType = lvl.bossType || 'terminator';
                boss = {
                    x: lvl.bossData.x, y: lvl.bossData.y,
                    w: lvl.bossData.w, h: lvl.bossData.h,
                    maxHp: lvl.bossData.maxHp, hp: lvl.bossData.maxHp,
                    baseY: lvl.bossData.y, bobTimer: 0
                };
                bossProjectiles = [];
                bossFireTimer = 0;
                bossDefeated = false;
                bossDeathTimer = 0;
                bossFlashTimer = 0;
                bossPulse = 0;
                queenBurstCount = 0;
                queenBurstTimer = 0;
                queenGlitchTimer = 0;
            } else {
                boss = null;
                bossProjectiles = [];
                bossDefeated = false;
            }
            document.getElementById('levelDisplay').innerText = lvl.isBoss ? 'BOSS FIGHT' : `LEVEL ${(index + 1).toString().padStart(2, '0')}`;
            document.getElementById('scoreDisplay').innerText = `SCORE: ${score.toString().padStart(4, '0')}`;
            updateMusicForLevel();
        }
        function update() {
            if (shopOpen) return;
            if (shopOpen || settingsOpen) return;
            // Decay screen shake
            screenShakeX *= 0.8;
            screenShakeY *= 0.8;
            if (Math.abs(screenShakeX) < 0.1) screenShakeX = 0;
            if (Math.abs(screenShakeY) < 0.1) screenShakeY = 0;
            if (deathTimer > 0) {
                deathTimer--; if (deathTimer === 0) loadLevel(currentLevel);
                particles.forEach((p, i) => { p.update(); if (p.alpha <= 0) particles.splice(i, 1); });
                return;
            }
            // Boss death cinematic
            if (bossDeathTimer > 0) {
                bossDeathTimer--;
                if (bossDeathTimer % 5 === 0 && boss) {
                    createExplosion(
                        boss.x + Math.random() * boss.w,
                        boss.y + Math.random() * boss.h,
                        ['#ff0055', '#ff3333', '#ffcc00', '#bc13fe'][Math.floor(Math.random() * 4)],
                        10
                    );
                }
                if (bossDeathTimer === 0) {
                    bossDefeated = true;
                    score += bossType === 'queen' ? 750 : 500;
                    document.getElementById('scoreDisplay').innerText = `SCORE: ${score.toString().padStart(4, '0')}`;
                }
                particles.forEach((p, i) => { p.update(); if (p.alpha <= 0) particles.splice(i, 1); });
                return;
            }
            // 1. Store state from previous frame
            player.oldY = player.y;
            player.wasGrounded = player.grounded;
            // 2. Horizontal Input
            if (keys['ArrowRight'] || keys['d']) { if (player.velX < player.speed) player.velX += 1.0; }
            if (keys['ArrowLeft'] || keys['a']) { if (player.velX > -player.speed) player.velX -= 1.0; }
            // Start stopwatch on first movement
            if (!stopwatchStarted && !gameFinished && (keys['ArrowRight'] || keys['d'] || keys['ArrowLeft'] || keys['a'] || keys['ArrowUp'] || keys['w'] || keys[' '])) {
                stopwatchStarted = true;
                stopwatchStartTime = performance.now();
            }
            
            // 3. Jump Logic (Only if grounded or in coyote time)
            if ((keys['ArrowUp'] || keys['w'] || keys[' ']) && (player.grounded || hangTime < 6)) {
            if (isMod && (keys['ArrowUp'] || keys['w'] || keys[' '])) {
                // Mod fly mode: hold jump to fly upward
                player.velY = -6;
                player.grounded = false;
                hangTime = 10;
            } else if ((keys['ArrowUp'] || keys['w'] || keys[' ']) && (player.grounded || hangTime < 6)) {
                player.velY = player.jumpPower;
                player.grounded = false; 
                hangTime = 10;
                createExplosion(player.x + player.width/2, player.y + player.height, player.color, 8);
                playSfxJump();
            }
            // 4. Physics: Apply Friction & Gravity
            player.velX *= friction;
            
            if (!player.grounded) {
                player.velY += gravity;
                hangTime++;
            } else {
                player.velY = 0;
                hangTime = 0;
            }
            player.grounded = false;
            // 5. Apply Movement
            const lvl = levels[currentLevel];
            player.x += player.velX;
            player.x = Math.max(0, Math.min(player.x, lvl.width - player.width));
            player.y += player.velY;
            // 6. Visual Trails
            if (Math.abs(player.velX) > 2) {
                trails.push({ x: player.x, y: player.y, rot: player.rotation, alpha: 0.5, shape: player.shape });
            }
            trails.forEach((t, i) => { t.alpha -= 0.05; if (t.alpha <= 0) trails.splice(i, 1); });
            // === BOSS LOGIC ===
            if (boss && !bossDefeated && bossDeathTimer === 0) {
                boss.bobTimer += 0.03;
                bossPulse += 0.05;
                if (bossType === 'queen') {
                    // Queen bobs more erratically
                    boss.y = boss.baseY + Math.sin(boss.bobTimer * 1.5) * 25 + Math.sin(boss.bobTimer * 3.7) * 8;
                    queenGlitchTimer++;
                    // Queen fires bursts of 2 projectiles with Y-tracking
                    // Queen fires bursts of 1 projectile with Y-tracking
                    bossFireTimer++;
                    let fireRate = 100 - ((boss.maxHp - boss.hp) * 7);
                    if (fireRate < 45) fireRate = 45;
                    if (queenBurstCount > 0) {
                        queenBurstTimer++;
                        if (queenBurstTimer >= 8) {
                            queenBurstTimer = 0;
                            queenBurstCount--;
                            let trackY = player.y - (boss.y + boss.h / 2);
                            let trackAmount = trackY * 0.15;
                            bossProjectiles.push({
                                x: boss.x,
                                y: boss.y + boss.h / 2 - 8 + trackAmount + (Math.random() - 0.5) * 30,
                                w: 14, h: 14,
                                speed: -(5 + (boss.maxHp - boss.hp) * 0.6),
                                isQueen: true,
                                sineOffset: Math.random() * Math.PI * 2,
                                sineAmp: (Math.random() * 2 + 1),
                                age: 0
                            });
                        }
                    } else if (bossFireTimer >= fireRate) {
                        bossFireTimer = 0;
                        queenBurstCount = 2;
                        queenBurstCount = 1;
                        queenBurstTimer = 0;
                    }
                    // Queen also fires sine-wave projectiles periodically
                    if (queenGlitchTimer % (180 - (boss.maxHp - boss.hp) * 10) === 0 && queenGlitchTimer > 0) {
                        for (let w = 0; w < 1; w++) {
                            bossProjectiles.push({
                                x: boss.x,
                                y: boss.y + boss.h * 0.3 + w * boss.h * 0.4,
                                w: 20, h: 10,
                                speed: -(3 + (boss.maxHp - boss.hp) * 0.5),
                                isQueen: true,
                                isWave: true,
                                sineOffset: w * Math.PI,
                                sineAmp: 40,
                                baseY: boss.y + boss.h * 0.3 + w * boss.h * 0.4,
                                age: 0
                            });
                        }
                    }
                } else {
                    // Terminator: original behavior
                    boss.y = boss.baseY + Math.sin(boss.bobTimer) * 15;
                    // Boss fires projectiles - gets faster as HP drops
                    bossFireTimer++;
                    let fireRate = 90 - ((boss.maxHp - boss.hp) * 12);
                    if (fireRate < 35) fireRate = 35;
                    if (bossFireTimer >= fireRate) {
                        bossFireTimer = 0;
                        bossProjectiles.push({
                            x: boss.x,
                            y: boss.y + boss.h / 2 - 8 + (Math.random() - 0.5) * 60,
                            w: 16, h: 16,
                            speed: -(4 + (boss.maxHp - boss.hp) * 0.8)
                        });
                    }
                }
                if (bossFlashTimer > 0) bossFlashTimer--;
            }
            // Update boss projectiles
            for (let i = bossProjectiles.length - 1; i >= 0; i--) {
                let proj = bossProjectiles[i];
                proj.x += proj.speed;
                if (proj.age !== undefined) proj.age++;
                // Sine-wave movement for queen wave projectiles
                if (proj.isWave && proj.baseY !== undefined) {
                    proj.y = proj.baseY + Math.sin((proj.age * 0.08) + proj.sineOffset) * proj.sineAmp;
                } else if (proj.isQueen && proj.sineAmp && !proj.isWave) {
                    proj.y += Math.sin((proj.age * 0.1) + proj.sineOffset) * proj.sineAmp * 0.3;
                }
                if (proj.x < camera.x - 50) {
                    bossProjectiles.splice(i, 1);
                    continue;
                }
                // Collision with player
                if (player.x < proj.x + proj.w && player.x + player.width > proj.x &&
                    player.y < proj.y + proj.h && player.y + player.height > proj.y) {
                    bossProjectiles.splice(i, 1);
                    triggerDeath();
                    return;
                }
            }
            // 7. Collision Detection Loop
            for (let obj of lvl.objects) {
                if (obj.type === 'enemy' && !obj.isDead) {
                    obj.currentX += obj.speed * obj.dir;
                    if (Math.abs(obj.currentX - obj.startX) > obj.range) obj.dir *= -1;
                    obj.x = obj.currentX;
                }
                
                if (player.x < obj.x + obj.w - 4 && player.x + player.width > obj.x + 4 &&
                    player.y < obj.y + obj.h - 4 && player.y + player.height > obj.y + 4) {
                    
                    if (obj.type === 'lava') { triggerDeath(); return; }
                    
                    else if (obj.type === 'enemy' && !obj.isDead) {
                        if (player.velY > 0 && (player.oldY + player.height) <= obj.y + 10) {
                            obj.isDead = true; player.velY = -8; score += 100;
                            document.getElementById('scoreDisplay').innerText = `SCORE: ${score.toString().padStart(4, '0')}`;
                            createExplosion(obj.x + obj.w/2, obj.y + obj.h/2, '#8e44ad', 15);
                        } else { triggerDeath(); return; }
                    }
                    else if (obj.type === 'weakpoint' && !obj.isUsed) {
                        // Stomp the damage core to hurt the boss
                        if (player.velY > 0 && (player.oldY + player.height) <= obj.y + 10) {
                            obj.isUsed = true;
                            player.velY = -10;
                            score += 200;
                            document.getElementById('scoreDisplay').innerText = `SCORE: ${score.toString().padStart(4, '0')}`;
                            createExplosion(obj.x + obj.w/2, obj.y + obj.h/2, '#ffcc00', 20);
                            createExplosion(obj.x + obj.w/2, obj.y + obj.h/2, '#ff0055', 15);
                            if (boss && boss.hp > 0) {
                                boss.hp--;
                                bossFlashTimer = 15;
                                triggerScreenShake(8);
                                playSfxBossHit();
                                createExplosion(boss.x + boss.w/2, boss.y + boss.h/2, '#ff0055', 20);
                                if (boss.hp <= 0) {
                                    bossDeathTimer = 90;
                                    bossProjectiles = [];
                                    triggerScreenShake(16);
                                }
                            }
                        }
                    }
                    else if (obj.type === 'glitch_orb' && !obj.isUsed) {
                        // Glitch orbs are collected on ANY touch (not stomp)
                        obj.isUsed = true;
                        player.velY = -6;
                        score += 250;
                        document.getElementById('scoreDisplay').innerText = `SCORE: ${score.toString().padStart(4, '0')}`;
                        createExplosion(obj.x + obj.w/2, obj.y + obj.h/2, '#bc13fe', 25);
                        createExplosion(obj.x + obj.w/2, obj.y + obj.h/2, '#e040fb', 20);
                        createExplosion(obj.x + obj.w/2, obj.y + obj.h/2, '#ffffff', 10);
                        if (boss && boss.hp > 0) {
                            boss.hp--;
                            bossFlashTimer = 20;
                            triggerScreenShake(10);
                            playSfxBossHit();
                            createExplosion(boss.x + boss.w/2, boss.y + boss.h/2, '#bc13fe', 25);
                            createExplosion(boss.x + boss.w/2, boss.y + boss.h/2, '#e040fb', 15);
                            if (boss.hp <= 0) {
                                bossDeathTimer = 120;
                                bossProjectiles = [];
                                triggerScreenShake(20);
                            }
                        }
                    }
                    
                    else if (obj.type === 'goal') { currentLevel++; loadLevel(currentLevel); return; }
                    else if (obj.type === 'goal') { playSfxLevelComplete(); currentLevel++; loadLevel(currentLevel); return; }
                    else if (obj.type === 'boss_goal') {
                        if (bossDefeated) { currentLevel++; loadLevel(currentLevel); return; }
                    }
                    
                    else if (obj.type === 'platform') {
                        if (player.velY >= 0 && (player.oldY + player.height) <= obj.y + 6) {
                            player.grounded = true; 
                            player.velY = 0; 
                            player.y = obj.y - player.height;
                            if (!player.wasGrounded) createExplosion(player.x + player.width/2, player.y + player.height, player.color, 5);
                        } else {
                            if (player.velX > 0) player.x = obj.x - player.width;
                            else if (player.velX < 0) player.x = obj.x + obj.w;
                            player.velX = 0;
                        }
                    }
                }
            }
            // Player collision with boss body
            if (boss && !bossDefeated && bossDeathTimer === 0) {
                if (player.x < boss.x + boss.w && player.x + player.width > boss.x &&
                    player.y < boss.y + boss.h && player.y + player.height > boss.y) {
                    triggerDeath();
                    return;
                }
            }
            // 8. Cleanup and Camera
            particles.forEach((p, i) => { p.update(); if (p.alpha <= 0) particles.splice(i, 1); });
            if (player.y > canvas.height + 100) triggerDeath();
            player.rotation += player.velX * 0.08;
            camera.x = player.x - canvas.width / 2;
            camera.x = Math.max(0, Math.min(camera.x, lvl.width - canvas.width));
        }
        function drawShape(x, y, size, shape, color, rot, alpha) {
            ctx.save();
            ctx.globalAlpha = alpha;
            ctx.translate(x + size/2, y + size/2);
            ctx.rotate(rot);
            ctx.fillStyle = color;
            ctx.shadowBlur = 15; ctx.shadowColor = color;
            
            if (shape === 'cube') {
                ctx.fillRect(-size/2, -size/2, size, size);
            } else if (shape === 'tri') {
                ctx.beginPath();
                ctx.moveTo(0, -size/2);
                ctx.lineTo(size/2, size/2);
                ctx.lineTo(-size/2, size/2);
                ctx.closePath();
                ctx.fill();
            } else if (shape === 'circle') {
                ctx.beginPath();
                ctx.arc(0, 0, size/2, 0, Math.PI * 2);
                ctx.fill();
            }
            ctx.restore();
        }
        function drawBoss() {
            if (!boss || bossDefeated) return;
            if (bossType === 'queen') { drawGlitchQueen(); return; }
            drawTerminator();
        }
        function drawTerminator() {
            if (!boss || bossDefeated) return;
            ctx.save();
            let bx = boss.x;
            let by = boss.y;
            // Flash when hit
            if (bossFlashTimer > 0 && bossFlashTimer % 4 < 2) {
                ctx.globalAlpha = 0.9;
            }
            // Boss body - dark crimson with pulsing glow
            let pulse = Math.sin(bossPulse) * 0.3 + 0.7;
            ctx.shadowBlur = 25 * pulse;
            ctx.shadowColor = '#ff0055';
            ctx.fillStyle = bossFlashTimer > 0 ? '#ffffff' : '#880022';
            ctx.fillRect(bx, by, boss.w, boss.h);
            // Inner core
            ctx.shadowBlur = 15;
            ctx.shadowColor = '#ff3333';
            ctx.fillStyle = bossFlashTimer > 0 ? '#ffcccc' : '#cc0033';
            ctx.fillRect(bx + 20, by + 30, boss.w - 40, boss.h - 60);
            // Pulsing energy lines
            ctx.strokeStyle = '#ff0055';
            ctx.lineWidth = 2;
            ctx.shadowBlur = 10;
            for (let i = 0; i < 3; i++) {
                let ly = by + 40 + i * 45;
                ctx.beginPath();
                ctx.moveTo(bx + 10, ly);
                for (let lx = bx + 10; lx < bx + boss.w - 10; lx += 8) {
                    ctx.lineTo(lx, ly + Math.sin((lx + bossPulse * 20) * 0.1) * 5);
                }
                ctx.stroke();
            }
            // Eyes
            ctx.shadowBlur = 20;
            ctx.shadowColor = '#ff0000';
            ctx.fillStyle = '#ff0055';
            ctx.fillRect(bx + 30, by + 50, 30, 15);
            ctx.fillRect(bx + 90, by + 50, 30, 15);
            // Pupils track player
            let pupilOffset = player.x < boss.x ? -3 : 3;
            ctx.fillStyle = '#ffffff';
            ctx.fillRect(bx + 38 + pupilOffset, by + 53, 12, 8);
            ctx.fillRect(bx + 98 + pupilOffset, by + 53, 12, 8);
            // Mouth
            ctx.fillStyle = '#ff0033';
            ctx.fillRect(bx + 35, by + 100, boss.w - 70, 8);
            ctx.fillStyle = '#ffcccc';
            for (let t = 0; t < 5; t++) {
                ctx.fillRect(bx + 40 + t * 15, by + 100, 8, 12);
            }
            // Border
            ctx.strokeStyle = '#ff0055';
            ctx.lineWidth = 3;
            ctx.shadowBlur = 20;
            ctx.strokeRect(bx + 2, by + 2, boss.w - 4, boss.h - 4);
            ctx.shadowBlur = 0;
            ctx.restore();
        }
        function drawGlitchQueen() {
            if (!boss || bossDefeated) return;
            ctx.save();
            let bx = boss.x;
            let by = boss.y;
            // Flash when hit
            if (bossFlashTimer > 0 && bossFlashTimer % 3 < 2) {
                ctx.globalAlpha = 0.85;
            }
            let pulse = Math.sin(bossPulse) * 0.3 + 0.7;
            let glitchShift = Math.sin(bossPulse * 7) > 0.9 ? (Math.random() * 6 - 3) : 0;
            // Glitch queen body - deep purple with magenta glow
            ctx.shadowBlur = 30 * pulse;
            ctx.shadowColor = '#bc13fe';
            ctx.fillStyle = bossFlashTimer > 0 ? '#ffffff' : '#2a0040';
            ctx.fillRect(bx + glitchShift, by, boss.w, boss.h);
            // Inner robe
            ctx.shadowBlur = 15;
            ctx.shadowColor = '#e040fb';
            ctx.fillStyle = bossFlashTimer > 0 ? '#eeccff' : '#5a0080';
            ctx.fillRect(bx + 15 + glitchShift, by + 40, boss.w - 30, boss.h - 50);
            // Crown - 3 triangular spikes
            ctx.fillStyle = bossFlashTimer > 0 ? '#ffffff' : '#e040fb';
            ctx.shadowBlur = 20;
            ctx.shadowColor = '#e040fb';
            for (let c = 0; c < 3; c++) {
                let cx = bx + 25 + c * 35 + glitchShift;
                ctx.beginPath();
                ctx.moveTo(cx, by);
                ctx.lineTo(cx + 15, by - 25 - Math.sin(bossPulse + c) * 5);
                ctx.lineTo(cx + 30, by);
                ctx.closePath();
                ctx.fill();
            }
            // Crown gems
            ctx.fillStyle = '#ffcc00';
            ctx.shadowColor = '#ffcc00';
            ctx.shadowBlur = 10;
            for (let c = 0; c < 3; c++) {
                ctx.beginPath();
                ctx.arc(bx + 40 + c * 35 + glitchShift, by - 8, 4, 0, Math.PI * 2);
                ctx.fill();
            }
            // Glitch scanlines
            ctx.globalAlpha = 0.3;
            ctx.fillStyle = '#bc13fe';
            for (let sl = 0; sl < boss.h; sl += 4) {
                if (Math.sin(sl * 0.5 + bossPulse * 10) > 0.3) {
                    ctx.fillRect(bx + glitchShift, by + sl, boss.w, 2);
                }
            }
            ctx.globalAlpha = bossFlashTimer > 0 ? 0.85 : 1;
            // Eyes - almond-shaped, glowing purple
            ctx.shadowBlur = 20;
            ctx.shadowColor = '#e040fb';
            ctx.fillStyle = '#e040fb';
            // Left eye
            ctx.beginPath();
            ctx.ellipse(bx + 40 + glitchShift, by + 65, 18, 10, 0, 0, Math.PI * 2);
            ctx.fill();
            // Right eye
            ctx.beginPath();
            ctx.ellipse(bx + 90 + glitchShift, by + 65, 18, 10, 0, 0, Math.PI * 2);
            ctx.fill();
            // Pupils track player - diamond shaped
            let pupilOffset = player.x < boss.x ? -4 : 4;
            ctx.fillStyle = '#ffffff';
            ctx.shadowBlur = 8;
            ctx.shadowColor = '#ffffff';
            for (let eye of [40, 90]) {
                ctx.beginPath();
                let px = bx + eye + pupilOffset + glitchShift;
                let py = by + 65;
                ctx.moveTo(px, py - 6);
                ctx.lineTo(px + 5, py);
                ctx.moveTo(px, py - 6);
                ctx.lineTo(px - 5, py);
                ctx.lineTo(px, py + 6);
                ctx.lineTo(px + 5, py);
                ctx.closePath();
                ctx.fill();
            }
            // Mouth - thin smirk
            ctx.strokeStyle = '#e040fb';
            ctx.lineWidth = 2;
            ctx.shadowBlur = 8;
            ctx.shadowColor = '#e040fb';
            ctx.beginPath();
            ctx.moveTo(bx + 35 + glitchShift, by + 105);
            ctx.quadraticCurveTo(bx + 65 + glitchShift, by + 115, bx + 95 + glitchShift, by + 103);
            ctx.stroke();
            // Floating glitch particles around queen
            ctx.fillStyle = '#bc13fe';
            ctx.shadowBlur = 5;
            for (let g = 0; g < 6; g++) {
                let gx = bx + boss.w/2 + Math.sin(bossPulse * 2 + g * 1.05) * (boss.w * 0.7);
                let gy = by + boss.h/2 + Math.cos(bossPulse * 1.5 + g * 1.05) * (boss.h * 0.5);
                ctx.globalAlpha = 0.5 + Math.sin(bossPulse * 3 + g) * 0.3;
                ctx.fillRect(gx - 3, gy - 3, 6, 6);
            }
            ctx.globalAlpha = 1;
            // Border with glitch effect
            ctx.strokeStyle = '#bc13fe';
            ctx.lineWidth = 2;
            ctx.shadowBlur = 20;
            ctx.shadowColor = '#bc13fe';
            ctx.strokeRect(bx + 2 + glitchShift, by + 2, boss.w - 4, boss.h - 4);
            // Second offset border for glitch
            if (Math.sin(bossPulse * 5) > 0.7) {
                ctx.strokeStyle = '#e040fb';
                ctx.globalAlpha = 0.5;
                ctx.strokeRect(bx + 5 - glitchShift, by + 5, boss.w - 10, boss.h - 10);
                ctx.globalAlpha = 1;
            }
            ctx.shadowBlur = 0;
            ctx.restore();
        }
        function drawGlitchOrb(obj) {
            if (obj.isUsed) return;
            let glow = Math.sin(bossPulse * 3) * 0.4 + 0.6;
            let floatY = Math.sin(bossPulse * 2 + obj.x * 0.01) * 4;
            ctx.save();
            // Outer glow
            ctx.shadowBlur = 25 * glow;
            ctx.shadowColor = '#bc13fe';
            // Diamond shape
            ctx.fillStyle = '#bc13fe';
            ctx.beginPath();
            let cx = obj.x + obj.w/2;
            let cy = obj.y + obj.h/2 + floatY;
            ctx.moveTo(cx, cy - obj.h/2);
            ctx.lineTo(cx + obj.w/2, cy);
            ctx.lineTo(cx, cy + obj.h/2);
            ctx.lineTo(cx - obj.w/2, cy);
            ctx.closePath();
            ctx.fill();
            // Inner core
            ctx.fillStyle = '#ffffff';
            ctx.globalAlpha = glow;
            ctx.beginPath();
            ctx.moveTo(cx, cy - obj.h/4);
            ctx.lineTo(cx + obj.w/4, cy);
            ctx.lineTo(cx, cy + obj.h/4);
            ctx.lineTo(cx - obj.w/4, cy);
            ctx.closePath();
            ctx.fill();
            ctx.globalAlpha = 1;
            // Orbiting sparkles
            ctx.fillStyle = '#e040fb';
            ctx.shadowBlur = 8;
            for (let s = 0; s < 3; s++) {
                let angle = bossPulse * 3 + s * (Math.PI * 2 / 3);
                let sx = cx + Math.cos(angle) * 18;
                let sy = cy + Math.sin(angle) * 12;
                ctx.fillRect(sx - 2, sy - 2, 4, 4);
            }
            ctx.shadowBlur = 0;
            ctx.restore();
        }
        function drawBossHealthBar() {
            if (!boss || bossDefeated) return;
            ctx.save();
            let barW = 300;
            let barH = 18;
            let barX = (canvas.width - barW) / 2;
            let barY = 15;
            let isQueen = bossType === 'queen';
            let bossColor = isQueen ? '#bc13fe' : '#ff0055';
            let bossName = isQueen ? 'THE GLITCH QUEEN' : 'THE TERMINATOR';
            // Label
            ctx.fillStyle = bossColor;
            ctx.font = 'bold 14px Segoe UI';
            ctx.textAlign = 'center';
            ctx.shadowBlur = 10;
            ctx.shadowColor = bossColor;
            ctx.fillText(bossName, canvas.width / 2, barY - 2);
            // Bar background
            ctx.fillStyle = isQueen ? '#110022' : '#220011';
            ctx.fillRect(barX, barY, barW, barH);
            // Health fill
            let hpRatio = boss.hp / boss.maxHp;
            let fillColor;
            if (isQueen) {
                fillColor = hpRatio > 0.5 ? '#bc13fe' : (hpRatio > 0.25 ? '#e040fb' : '#ff55ff');
            } else {
                fillColor = hpRatio > 0.5 ? '#ff0055' : (hpRatio > 0.25 ? '#ff6600' : '#ff3333');
            }
            ctx.fillStyle = fillColor;
            ctx.shadowBlur = 8;
            ctx.shadowColor = fillColor;
            ctx.fillRect(barX + 2, barY + 2, (barW - 4) * hpRatio, barH - 4);
            // Border
            ctx.strokeStyle = bossColor;
            ctx.lineWidth = 2;
            ctx.shadowBlur = 5;
            ctx.strokeRect(barX, barY, barW, barH);
            // HP text
            ctx.fillStyle = '#ffffff';
            ctx.font = 'bold 11px Segoe UI';
            ctx.shadowBlur = 0;
            ctx.fillText(boss.hp + ' / ' + boss.maxHp, canvas.width / 2, barY + 14);
            ctx.restore();
        }
        function drawWeakpoint(obj) {
            if (obj.isUsed) return;
            let glow = Math.sin(bossPulse * 2) * 0.4 + 0.6;
            ctx.save();
            ctx.shadowBlur = 20 * glow;
            ctx.shadowColor = '#ffcc00';
            ctx.fillStyle = '#ffcc00';
            ctx.fillRect(obj.x, obj.y, obj.w, obj.h);
            ctx.fillStyle = '#ffffff';
            ctx.globalAlpha = glow;
            ctx.fillRect(obj.x + 5, obj.y + 3, obj.w - 10, obj.h - 6);
            ctx.globalAlpha = 1;
            ctx.strokeStyle = '#ff8800';
            ctx.lineWidth = 2;
            ctx.strokeRect(obj.x, obj.y, obj.w, obj.h);
            ctx.shadowBlur = 0;
            // Down arrow indicator
            ctx.fillStyle = '#ffcc00';
            ctx.beginPath();
            ctx.moveTo(obj.x + obj.w/2 - 8, obj.y - 15);
            ctx.lineTo(obj.x + obj.w/2 + 8, obj.y - 15);
            ctx.lineTo(obj.x + obj.w/2, obj.y - 5);
            ctx.closePath();
            ctx.fill();
            ctx.restore();
        }
        function drawBossProjectile(proj) {
            ctx.save();
            if (proj.isQueen) {
                if (proj.isWave) {
                    // Wave projectile - elongated glitch bar
                    ctx.shadowBlur = 12;
                    ctx.shadowColor = '#e040fb';
                    ctx.fillStyle = '#bc13fe';
                    ctx.fillRect(proj.x, proj.y, proj.w, proj.h);
                    ctx.fillStyle = '#ffffff';
                    ctx.globalAlpha = 0.6;
                    ctx.fillRect(proj.x + 3, proj.y + 2, proj.w - 6, proj.h - 4);
                    ctx.globalAlpha = 1;
                } else {
                    // Burst projectile - diamond shape
                    ctx.shadowBlur = 15;
                    ctx.shadowColor = '#bc13fe';
                    ctx.fillStyle = '#e040fb';
                    let cx = proj.x + proj.w/2;
                    let cy = proj.y + proj.h/2;
                    ctx.beginPath();
                    ctx.moveTo(cx, cy - proj.h/2);
                    ctx.lineTo(cx + proj.w/2, cy);
                    ctx.lineTo(cx, cy + proj.h/2);
                    ctx.lineTo(cx - proj.w/2, cy);
                    ctx.closePath();
                    ctx.fill();
                    ctx.fillStyle = '#ffffff';
                    ctx.beginPath();
                    ctx.arc(cx, cy, proj.w/5, 0, Math.PI * 2);
                    ctx.fill();
                }
            } else {
                ctx.shadowBlur = 15;
                ctx.shadowColor = '#ff0055';
                ctx.fillStyle = '#ff0055';
                ctx.beginPath();
                ctx.arc(proj.x + proj.w/2, proj.y + proj.h/2, proj.w/2, 0, Math.PI * 2);
                ctx.fill();
                ctx.fillStyle = '#ff8888';
                ctx.beginPath();
                ctx.arc(proj.x + proj.w/2, proj.y + proj.h/2, proj.w/4, 0, Math.PI * 2);
                ctx.fill();
            }
            ctx.shadowBlur = 0;
            ctx.restore();
        }
        function drawBackground() {
            ctx.strokeStyle = '#151525';
            ctx.lineWidth = 1;
            let gridOffset = (camera.x * 0.1) % 100;
            ctx.beginPath();
            for(let x = -gridOffset; x < canvas.width; x += 100) {
                ctx.moveTo(x, 0); ctx.lineTo(x, canvas.height);
            }
            for(let y = 0; y < canvas.height; y += 50) {
                ctx.moveTo(0, y); ctx.lineTo(canvas.width, y);
            }
            ctx.stroke();
            ctx.strokeStyle = '#1a1a2e';
            hexes.forEach(h => {
                let hX = (h.x - (camera.x * h.speed)) % (levels[currentLevel].width + 400);
                if (hX < -100) hX += levels[currentLevel].width + 400;
                ctx.beginPath();
                for (let i = 0; i < 6; i++) {
                    let angle = (Math.PI * 2 / 6) * i;
                    let px = hX + h.size * Math.cos(angle);
                    let py = h.y + h.size * Math.sin(angle);
                    if (i === 0) ctx.moveTo(px, py); else ctx.lineTo(px, py);
                }
                ctx.closePath();
                ctx.stroke();
            });
        }
        function draw() {
            ctx.fillStyle = '#0a0a0f';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            drawBackground();
            ctx.save();
            ctx.translate(-camera.x, -camera.y);
            ctx.translate(-camera.x + screenShakeX, -camera.y + screenShakeY);
            trails.forEach(t => {
                drawShape(t.x, t.y, player.width, t.shape, player.color, t.rot, t.alpha);
            });
            levels[currentLevel].objects.forEach(obj => {
                if (obj.type === 'platform') {
                    ctx.fillStyle = '#1a1a25'; ctx.fillRect(obj.x, obj.y, obj.w, obj.h);
                    ctx.strokeStyle = '#00d2ff'; ctx.lineWidth = 2;
                    ctx.strokeRect(obj.x, obj.y, obj.w, 1);
                }
                else if (obj.type === 'lava') {
                    ctx.fillStyle = '#ff3333';
                    ctx.shadowBlur = 10; ctx.shadowColor = '#ff3333';
                    ctx.fillRect(obj.x, obj.y, obj.w, obj.h);
                    ctx.shadowBlur = 0;
                }
                else if (obj.type === 'goal') {
                    ctx.strokeStyle = '#00ff88'; ctx.lineWidth = 3;
                    ctx.shadowBlur = 15; ctx.shadowColor = '#00ff88';
                    ctx.strokeRect(obj.x + 5, obj.y + 5, obj.w - 10, obj.h - 10);
                    ctx.shadowBlur = 0;
                }
                else if (obj.type === 'boss_goal') {
                    if (bossDefeated) {
                        let glow = Math.sin(bossPulse * 3) * 0.3 + 0.7;
                        ctx.strokeStyle = '#00ff88'; ctx.lineWidth = 3;
                        ctx.shadowBlur = 25 * glow; ctx.shadowColor = '#00ff88';
                        ctx.strokeRect(obj.x + 5, obj.y + 5, obj.w - 10, obj.h - 10);
                        ctx.shadowBlur = 0;
                        ctx.fillStyle = '#00ff88';
                        ctx.font = 'bold 10px Segoe UI';
                        ctx.textAlign = 'center';
                        ctx.fillText('EXIT', obj.x + obj.w/2, obj.y - 5);
                    } else {
                        ctx.strokeStyle = '#331111'; ctx.lineWidth = 2;
                        ctx.strokeRect(obj.x + 5, obj.y + 5, obj.w - 10, obj.h - 10);
                        ctx.fillStyle = '#331111';
                        ctx.font = 'bold 8px Segoe UI';
                        ctx.textAlign = 'center';
                        ctx.fillText('LOCKED', obj.x + obj.w/2, obj.y - 5);
                    }
                }
                else if (obj.type === 'enemy' && !obj.isDead) {
                    ctx.fillStyle = '#bc13fe'; ctx.fillRect(obj.x, obj.y, obj.w, obj.h);
                    ctx.fillStyle = '#ff0055';
                    let eyeX = obj.dir === 1 ? obj.x + 25 : obj.x + 5;
                    ctx.fillRect(eyeX, obj.y + 10, 10, 5);
                }
                else if (obj.type === 'weakpoint') {
                    drawWeakpoint(obj);
                }
                else if (obj.type === 'glitch_orb') {
                    drawGlitchOrb(obj);
                }
            });
            // Draw boss
            drawBoss();
            // Draw boss projectiles
            bossProjectiles.forEach(proj => drawBossProjectile(proj));
            particles.forEach(p => p.draw());
            if (player.visible) {
                drawShape(player.x, player.y, player.width, player.shape, player.color, player.rotation, 1);
            }
            ctx.restore();
            // Boss HUD overlay
            drawBossHealthBar();
            drawStopwatch();
            // Boss death cinematic
            if (bossDeathTimer > 0) {
                let isQueen = bossType === 'queen';
                let flashAlpha = (bossDeathTimer % 10 < 5) ? 0.15 : 0;
                ctx.fillStyle = isQueen ? 'rgba(188, 19, 254, ' + flashAlpha + ')' : 'rgba(255, 0, 50, ' + flashAlpha + ')';
                ctx.fillRect(0, 0, canvas.width, canvas.height);
                ctx.fillStyle = isQueen ? '#bc13fe' : '#ff0055';
                ctx.font = 'bold 36px Segoe UI';
                ctx.textAlign = 'center';
                ctx.shadowBlur = 20; ctx.shadowColor = isQueen ? '#bc13fe' : '#ff0055';
                ctx.fillText(isQueen ? 'DETHRONED' : 'TERMINATED', canvas.width / 2, canvas.height / 2);
                ctx.shadowBlur = 0;
            }
            // Boss defeated prompt
            if (bossDefeated && boss) {
                ctx.fillStyle = '#00ff88';
                ctx.font = 'bold 16px Segoe UI';
                ctx.textAlign = 'center';
                ctx.shadowBlur = 10; ctx.shadowColor = '#00ff88';
                ctx.fillText('BOSS DEFEATED - REACH THE EXIT!', canvas.width / 2, canvas.height / 2 - 30);
                ctx.shadowBlur = 0;
            }
            if (deathTimer > 0) {
                ctx.fillStyle = 'rgba(20, 0, 0, 0.6)';
                ctx.fillRect(0, 0, canvas.width, canvas.height);
                ctx.fillStyle = '#ff3333';
                ctx.font = 'bold 42px Segoe UI';
                ctx.textAlign = 'center';
                ctx.shadowBlur = 15; ctx.shadowColor = '#ff3333';
                ctx.fillText('SYSTEM CRITICAL', canvas.width / 2, canvas.height / 2);
                ctx.shadowBlur = 0;
                ctx.fillStyle = 'white';
                ctx.font = '20px Segoe UI';
                ctx.fillText('REBOOTING...', canvas.width / 2, canvas.height / 2 + 45);
            }
        }
        function gameLoop() { update(); draw(); requestAnimationFrame(gameLoop); }
        
        window.addEventListener('keydown', e => {
            if (!gameStarted) return;
            keys[e.key] = true;
            if (e.key === 's' || e.key === 'S') toggleShop();
            if (e.key === 'Escape') toggleSettings();
            if (e.key === 's' || e.key === 'S') { if (!settingsOpen) toggleShop(); }
            if ((e.key === 'l' || e.key === 'L') && isMod) toggleLevelSelector();
            if([" ", "ArrowUp", "ArrowDown", "ArrowLeft", "ArrowRight"].includes(e.key)) e.preventDefault();
        });
        window.addEventListener('keyup', e => keys[e.key] = false);
        // Mobile touch controls
        (function initMobileControls() {
            const isTouchDevice = ('ontouchstart' in window) || (navigator.maxTouchPoints > 0);
            if (isTouchDevice) {
                document.getElementById('mobileControls').style.display = 'flex';
            }
            function bindBtn(id, keyName, isToggle) {
                const el = document.getElementById(id);
                if (!el) return;
                function activate(e) {
                    e.preventDefault();
                    if (isToggle) {
                        toggleShop();
                        el.classList.add('active');
                        setTimeout(() => el.classList.remove('active'), 150);
                    } else {
                        keys[keyName] = true;
                        el.classList.add('active');
                    }
                }
                function deactivate(e) {
                    e.preventDefault();
                    if (!isToggle) {
                        keys[keyName] = false;
                        el.classList.remove('active');
                    }
                }
                el.addEventListener('touchstart', activate, { passive: false });
                el.addEventListener('touchend', deactivate, { passive: false });
                el.addEventListener('touchcancel', deactivate, { passive: false });
                // Also support mouse for testing on desktop
                el.addEventListener('mousedown', activate);
                el.addEventListener('mouseup', deactivate);
                el.addEventListener('mouseleave', deactivate);
            }
            bindBtn('btnLeft', 'ArrowLeft', false);
            bindBtn('btnRight', 'ArrowRight', false);
            bindBtn('btnJump', 'ArrowUp', false);
            bindBtn('btnShop', null, true);
            // Prevent default touch behavior on the entire game area to avoid scrolling
            document.body.addEventListener('touchmove', function(e) {
                e.preventDefault();
            }, { passive: false });
        })();
        loadLevel(currentLevel);
        gameLoop();
        // Username system
        function startGame() {
            const input = document.getElementById('usernameInput').value.trim();
            if (!input) return;
            initAudio();
            playerUsername = input;
            isMod = (playerUsername === 'AmxthystBloxMOD');
            document.getElementById('usernameOverlay').style.display = 'none';
            document.getElementById('usernameDisplay').innerText = isMod ? '' : playerUsername;
            if (isMod) {
                buildLevelSelector();
            }
            gameStarted = true;
            loadLevel(currentLevel);
            gameLoop();
        }
        function buildLevelSelector() {
            const sel = document.getElementById('levelSelector');
            sel.innerHTML = '<h3>LEVEL SELECT</h3>';
            const levelNames = [
                'Level 1: Intro', 'Level 2: Lava Gaps', 'Level 3: Enemy Gauntlet',
                'Level 4: Vertical Platforming', 'Level 5: Mixed Hazards', 'Level 6: The Stairway',
                'Level 7: Lava Corridors', 'Level 8: The Gauntlet', 'Level 9: BOSS - Terminator',
                'Level 10: Aftershock', 'Level 11: Neon Highways', 'Level 12: Vertical Limit',
                'Level 13: Inferno', 'Level 14: Phantom Run', 'Level 15: Sky Fortress',
                'Level 16: Death Spiral', 'Level 17: Final Protocol', 'Level 18: BOSS - Glitch Queen'
            ];
            for (let i = 0; i < levels.length; i++) {
                const btn = document.createElement('button');
                btn.className = 'level-btn';
                btn.innerText = levelNames[i] || ('Level ' + (i + 1));
                btn.onclick = function() {
                    currentLevel = i;
                    loadLevel(currentLevel);
                    toggleLevelSelector();
                };
                sel.appendChild(btn);
            }
            const closeBtn = document.createElement('button');
            closeBtn.style.cssText = 'margin-top:8px;background:#ff3333;border:none;color:white;padding:5px;cursor:pointer;border-radius:4px;';
            closeBtn.innerText = 'CLOSE';
            closeBtn.onclick = toggleLevelSelector;
            sel.appendChild(closeBtn);
        }
        function toggleLevelSelector() {
            if (!isMod) return;
            levelSelectorOpen = !levelSelectorOpen;
            document.getElementById('levelSelector').style.display = levelSelectorOpen ? 'flex' : 'none';
        }
        document.getElementById('usernameSubmit').addEventListener('click', startGame);
        document.getElementById('usernameInput').addEventListener('keydown', function(e) {
            if (e.key === 'Enter') startGame();
        });
        // Settings controls
        document.getElementById('particleSlider').addEventListener('input', function() {
            particleIntensity = this.value / 100;
            document.getElementById('particleValue').innerText = this.value + '%';
        });
        document.getElementById('shakeToggle').addEventListener('click', function() {
            screenShakeEnabled = !screenShakeEnabled;
            this.classList.toggle('active', screenShakeEnabled);
        });
        document.getElementById('timerCheckbox').addEventListener('click', function() {
            showSpeedrunTimer = !showSpeedrunTimer;
            this.classList.toggle('checked', showSpeedrunTimer);
            this.innerHTML = showSpeedrunTimer ? '&#10003;' : '';
        });
        document.getElementById('settingsResetBtn').addEventListener('click', function() {
            if (!confirm('Reset all progress? Score and shop unlocks will be lost.')) return;
            score = 0;
            currentLevel = 0;
            player.color = '#00d2ff';
            player.shape = 'cube';
            player.unlocked = ['#00d2ff'];
            player.unlockedUnits = ['cube'];
            updateShopUI();
            document.getElementById('scoreDisplay').innerText = 'SCORE: 0000';
            stopwatchStarted = false; stopwatchStartTime = 0; stopwatchElapsed = 0;
            stopwatchFinal = 0; gameFinished = false;
            loadLevel(currentLevel);
            toggleSettings();
        });
        document.getElementById('settingsCloseBtn').addEventListener('click', function() {
            toggleSettings();
        });
        document.getElementById('musicSlider').addEventListener('input', function() {
            musicVolume = this.value / 100;
            document.getElementById('musicValue').innerText = this.value + '%';
            if (musicGain) musicGain.gain.value = musicVolume;
        });
        document.getElementById('sfxSlider').addEventListener('input', function() {
            sfxVolume = this.value / 100;
            document.getElementById('sfxValue').innerText = this.value + '%';
            if (sfxGain) sfxGain.gain.value = sfxVolume;
        });
    </script>
</body>
</html>
